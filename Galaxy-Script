repeat task.wait() until game:IsLoaded()
Players = game:GetService("Players")
repeat task.wait() until Players.LocalPlayer
LP, Camera = Players.LocalPlayer, workspace.CurrentCamera
UIS, RS, HS, TS = game:GetService("UserInputService"), game:GetService("RunService"), game:GetService("HttpService"), game:GetService("TweenService")
Mouse, VIM = LP:GetMouse(), nil
pcall(function() VIM = game:GetService("VirtualInputManager") end)
TextService = game:GetService("TextService")

local function Create(cls, parent, props)
    local obj = Instance.new(cls)
    for k, v in pairs(props or {}) do obj[k] = v end
    obj.Parent = parent
    return obj
end

local LoadGalaxy -- Forward Declaration

local function AddCorner(obj, r) return Create("UICorner", obj, {CornerRadius = UDim.new(0, r or 8)}) end
local function AddStroke(obj, color, thick, transparency) return Create("UIStroke", obj, {Color = color or Color3.fromRGB(50,50,50), Thickness = thick or 1, Transparency = transparency or 0}) end

local function CheckAuth()
    if isfile("galaxy.auth") then local s, d = pcall(function() return HS:JSONDecode(readfile("galaxy.auth")) end) if s and d.key=="2026" and os.time()-d.timestamp<86400 then return true end end return false
end

if not isfile("galaxy.name") then writefile("galaxy.name", LP.DisplayName) end
local userName = isfile("galaxy.name") and readfile("galaxy.name") or LP.DisplayName

-- // KEY SYSTEM //
local KeySystemGui = Create("ScreenGui", LP:WaitForChild("PlayerGui"), {Name = "GalaxyKeySystem", ResetOnSpawn = false})
local KeyFrame = Create("Frame", KeySystemGui, {Size = UDim2.new(0, 300, 0, 150), Position = UDim2.new(0.5, -150, 0.6, -75), BackgroundColor3 = Color3.fromRGB(20, 20, 25), BorderSizePixel = 0, BackgroundTransparency = 1, Visible = false})
Create("UICorner", KeyFrame, {CornerRadius = UDim.new(0, 8)})
local ks = Create("UIStroke", KeyFrame, {Color = Color3.fromRGB(170, 0, 255), Thickness = 2, Transparency = 1})
Create("TextLabel", KeyFrame, {Size = UDim2.new(1, 0, 0, 40), BackgroundTransparency = 1, Text = "GALAXY PROTECTION", TextColor3 = Color3.new(1, 1, 1), Font = Enum.Font.GothamBlack, TextSize = 18, TextTransparency = 1})
local KeyBox = Create("TextBox", KeyFrame, {Size = UDim2.new(0.8, 0, 0, 35), Position = UDim2.new(0.1, 0, 0.35, 0), BackgroundColor3 = Color3.fromRGB(35, 35, 40), TextColor3 = Color3.new(1, 1, 1), PlaceholderText = "Enter Access Key...", Font = Enum.Font.Gotham, TextSize = 14, BackgroundTransparency = 1, TextTransparency = 1})
Create("UICorner", KeyBox, {CornerRadius = UDim.new(0, 6)})
local KeyBtn = Create("TextButton", KeyFrame, {Size = UDim2.new(0.5, 0, 0, 30), Position = UDim2.new(0.25, 0, 0.7, 0), BackgroundColor3 = Color3.fromRGB(170, 0, 255), TextColor3 = Color3.new(1, 1, 1), Text = "Login", Font = Enum.Font.GothamBold, TextSize = 14, BackgroundTransparency = 1, TextTransparency = 1})
Create("UICorner", KeyBtn, {CornerRadius = UDim.new(0, 6)})

-- Welcome Screen
local WelcomeFrame = Create("Frame", KeySystemGui, {Size = UDim2.new(0, 350, 0, 180), Position = UDim2.new(0.5, -175, 0.5, -90), BackgroundColor3 = Color3.fromRGB(15, 15, 20), BorderSizePixel = 0})
AddCorner(WelcomeFrame, 10); AddStroke(WelcomeFrame, Color3.fromRGB(0, 242, 255), 2, 0.3)
local WelcomeText = Create("TextLabel", WelcomeFrame, {Size = UDim2.new(1, -20, 0, 80), Position = UDim2.new(0,10,0,20), BackgroundTransparency = 1, Text = (isfile("galaxy.auth") and "Добро пожаловать " .. userName or "Приветствую новый пользователь " .. userName), TextColor3 = Color3.new(1, 1, 1), Font = Enum.Font.GothamBold, TextSize = 20, TextWrapped = true})
local ContBtn = Create("TextButton", WelcomeFrame, {Size = UDim2.new(0, 160, 0, 35), Position = UDim2.new(0.5, -80, 0.6, 0), BackgroundColor3 = Color3.fromRGB(0, 242, 255), TextColor3 = Color3.new(0, 0, 0), Text = "Продолжить", Font = Enum.Font.GothamBlack, TextSize = 16})
AddCorner(ContBtn, 8)
local HintText = Create("TextLabel", WelcomeFrame, {Size = UDim2.new(1, 0, 0, 20), Position = UDim2.new(0, 0, 0.85, 0), BackgroundTransparency = 1, Text = "Открыть меню на Insert", TextColor3 = Color3.fromRGB(150, 150, 150), Font = Enum.Font.Gotham, TextSize = 14})

local function StartKeySystem()
    local isAuthorized = CheckAuth()
    game:GetService("TweenService"):Create(WelcomeFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Position = UDim2.new(0.5, -175, 0.4, -90), BackgroundTransparency = 1}):Play()
    for _, v in pairs(WelcomeFrame:GetDescendants()) do if not v:IsA("UICorner") and not v:IsA("UIStroke") then game:GetService("TweenService"):Create(v, TweenInfo.new(0.4), {TextTransparency = 1, BackgroundTransparency = 1}):Play() end end
    task.delay(0.5, function() 
        WelcomeFrame:Destroy()
        if isAuthorized then
            KeySystemGui:Destroy()
            LoadGalaxy()
        else
            KeyFrame.Visible = true
            game:GetService("TweenService"):Create(KeyFrame, TweenInfo.new(0.6, Enum.EasingStyle.Quint), {Position = UDim2.new(0.5, -150, 0.5, -75), BackgroundTransparency = 0}):Play()
            game:GetService("TweenService"):Create(ks, TweenInfo.new(0.8), {Transparency = 0}):Play()
            for _, v in pairs(KeyFrame:GetDescendants()) do 
                if v:IsA("TextLabel") or v:IsA("TextBox") or v:IsA("TextButton") then 
                    game:GetService("TweenService"):Create(v, TweenInfo.new(0.8), {TextTransparency = 0, BackgroundTransparency = (v:IsA("TextLabel") and 1 or 0)}):Play() 
                end 
            end
        end
    end)
end
ContBtn.MouseButton1Click:Connect(StartKeySystem)

LoadGalaxy = function()
    -- // SYSTEM CONNECTIONS //
    local Connections = {}
    local aimEnabled, triggerEnabled, triggerHolding = false, false, false
    local function Connect(signal, func)
        local c = signal:Connect(func)
        table.insert(Connections, c)
        return c
    end

    -- // SOUNDS //
    local function PlaySound(id)
        local s = Instance.new("Sound")
        s.SoundId = id
        s.Volume = 1
        s.Parent = game:GetService("SoundService")
        s.PlayOnRemove = true
        s.DestroyOnRemove = true
        s:Destroy()
    end
    local Sounds = {On = "rbxassetid://4612375233", Off = "rbxassetid://4612377140"}
    
    local PlayerConnections = {}
    local RefreshKeyList -- Forward Declaration for UI updates
    local lastRootJoint = nil
    local lastRootParent = nil
    local currentSeat = nil
    local seatTeleportPosition = Vector3.new(-25.95, 400, 3537.55)
    local voidLevelYThreshold = -50
    local TP1, TP2 = nil, nil

    local defCfg = {
        menuKey=Enum.KeyCode.Insert, aimKey=nil, triggerKey=nil, espKey=nil, flyKey=nil, zoomKey=nil,
        fovSize=300, silentAim=false, showFov=false, wallCheck=false, usePrediction=true, predictionFactor=0.05, aimSmoothing=1,
        espMode="All", theme="Rainbow", walkSpeed=16, jumpPower=50, noclip=false, tracers=false, infAmmo=false,
        antiAim=false, boxEsp=false, chams=false, chinaHat=false, keybindList=false, thirdPerson=false, thirdPersonDist=20, knifeBot=false, knifeRange=15, noRecoil=false, invisibility=false, binds={}
    }
    local config = {}
    local function ResetConfig() 
        for k,v in pairs(defCfg) do config[k] = v end 
        config.binds = {}
        aimEnabled, triggerEnabled = false, false
        -- Reset all HUD entries and return to defaults
        if ArrayList then
            for _,v in pairs(ArrayList:GetChildren()) do if v:IsA("Frame") then v:Destroy() end end
        end
        if RefreshKeyList then RefreshKeyList() end
        pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY", Text="All Config & Binds Cleared", Duration=3}) end)
    end
    ResetConfig()

    local Themes = {
        Rainbow = {Main = Color3.fromRGB(20,20,25), Accent = Color3.fromRGB(0, 255, 150)},
        Purple = {Main = Color3.fromRGB(20,20,25), Accent = Color3.fromRGB(170, 0, 255)},
        Blue = {Main = Color3.fromRGB(15,20,30), Accent = Color3.fromRGB(0, 150, 255)},
        Red = {Main = Color3.fromRGB(25,15,15), Accent = Color3.fromRGB(255, 50, 50)}
    }
    local CurrentTheme, ThemeObjects, rainbowColor = Themes.Rainbow, {}, Color3.new(1,1,1)
    
    local function RegisterTheme(obj, prop)
        table.insert(ThemeObjects, {Object = obj, Property = prop, Type = "Accent"})
    end

    local function Tween(obj, props, time) TS:Create(obj, TweenInfo.new(time or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play() end

    local function SilenceGun(tool)
        if not config.noRecoil then return end
        local function Scan(t, d)
            if d > 3 then return end
            for k, v in pairs(t) do
                if type(v) == "number" and (tostring(k):lower():find("recoil") or tostring(k):lower():find("spread")) then t[k] = 0
                elseif type(v) == "table" then Scan(v, d + 1) end
            end
        end
        for _, v in pairs(tool:GetDescendants()) do
            if v:IsA("ModuleScript") then local s, m = pcall(require, v); if s and type(m) == "table" then Scan(m, 1) end
            elseif v:IsA("NumberValue") and v.Name:lower():find("recoil") then v.Value = 0 end
        end
    end
    
    Connect(RS.Stepped, function()
        if not LP.Character then return end
        local tool = LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            if config.noRecoil then SilenceGun(tool) end
            if config.knifeBot then
                local root = LP.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    local closest, minDst = nil, config.knifeRange
                    for _, p in pairs(Players:GetPlayers()) do
                        if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
                            local d = (p.Character.HumanoidRootPart.Position - root.Position).Magnitude
                            if d < minDst then minDst, closest = d, p.Character.HumanoidRootPart end
                        end
                    end
                    if closest then root.CFrame = CFrame.lookAt(root.Position, Vector3.new(closest.Position.X, root.Position.Y, closest.Position.Z)); tool:Activate() end
                end
            end
        end
    end)

    Connect(RS.Heartbeat, function()
        if config.theme == "Rainbow" then
            rainbowColor = Color3.fromHSV(tick() % 5 / 5, 0.8, 1)
            for _, item in pairs(ThemeObjects) do 
                if item.Object and item.Object.Parent then 
                    if item.Object:IsA("Frame") and item.Object.BackgroundColor3 ~= Color3.fromRGB(45,48,54) then
                        item.Object[item.Property] = rainbowColor 
                    elseif item.Object:IsA("TextLabel") or item.Object:IsA("UIStroke") or item.Object:IsA("ImageLabel") or item.Object:IsA("Beam") then
                        item.Object[item.Property] = rainbowColor
                    end
                end 
            end
        end
    end)

    -- // UI PRE-SETUP (v11.0 CYBER SLATE) //
    if LP.PlayerGui:FindFirstChild("GalaxyX") then LP.PlayerGui.GalaxyX:Destroy() end
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GalaxyX"
    ScreenGui.Parent = LP:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false
    ScreenGui.DisplayOrder = 10000 
    
    -- // CYBER SLATE COLORS //
    local Colors = {
        Background = Color3.fromRGB(15, 16, 18), -- Deep Slate
        Content = Color3.fromRGB(22, 23, 26),
        TopBar = Color3.fromRGB(28, 30, 34),
        Item = Color3.fromRGB(32, 34, 38),
        Hover = Color3.fromRGB(45, 50, 58),
        Text = Color3.fromRGB(255, 255, 255),
        TextDark = Color3.fromRGB(130, 135, 145),
        Accent = Color3.fromRGB(0, 242, 255) -- Cyan Glow
    }


    local WF = Create("Frame", ScreenGui, {Name="WF", Position=UDim2.new(0,15,0,15), Size=UDim2.new(0,110,0,32), BackgroundColor3=Colors.TopBar})
    AddCorner(WF, 8); local ws = AddStroke(WF, Colors.Accent, 1, 0.4); RegisterTheme(ws, "Color")
    local wl = Create("Frame", WF, {Size=UDim2.new(0,3,1,-12), Position=UDim2.new(0,6,0,6), BackgroundColor3=Colors.Accent}); RegisterTheme(wl, "BackgroundColor3")
    local Watermark = Create("TextLabel", WF, {Position=UDim2.new(0,15,0,0), Size=UDim2.new(1,-15,1,0), BackgroundTransparency=1, Text="GALAXY <font color='#00f2ff'>X</font>", RichText=true, Font="GothamBlack", TextColor3=Colors.Text, TextSize=16, TextXAlignment="Left"})

    local ArrayList = Create("Frame", ScreenGui, {Name="AL", Position=UDim2.new(0,15,0,55), Size=UDim2.new(0,200,0.5,0), BackgroundTransparency=1})
    Create("UIListLayout", ArrayList, {SortOrder="LayoutOrder", Padding=UDim.new(0,6)})

    local function UpdateHUD(name, state)
        if state then
            if ArrayList:FindFirstChild(name) then return end
            local f = Create("Frame", ArrayList, {Name=name, Size=UDim2.new(0,0,0,24), BackgroundColor3=Colors.Item, BackgroundTransparency=0.2, ClipsDescendants=true})
            AddCorner(f,4); local s = AddStroke(f, Colors.Accent,1,0.7); RegisterTheme(s, "Color")
            local l = Create("TextLabel", f, {Text="  "..name.."  ", Font="GothamBold", TextSize=13, TextColor3=Colors.Accent, BackgroundTransparency=1, Size=UDim2.new(1,0,1,0), TextXAlignment="Left"})
            RegisterTheme(l, "TextColor3")
            local ts = TextService:GetTextSize(l.Text, 13, l.Font, Vector2.new(500,500))
            Tween(f, {Size=UDim2.new(0, ts.X+8, 0, 24)}, 0.3)
            local entries = {}
            for _,c in pairs(ArrayList:GetChildren()) do if c:IsA("Frame") then table.insert(entries,c) end end
            table.sort(entries, function(a,b) return a.Size.X.Offset > b.Size.X.Offset end)
            for i,v in ipairs(entries) do v.LayoutOrder = i end
        else
            local f = ArrayList:FindFirstChild(name)
            if f then Tween(f, {Size=UDim2.new(0,0,0,24), BackgroundTransparency=1}, 0.2) task.delay(0.2, function() f:Destroy() end) end
        end
    end

    local MainFrame = Create("Frame", ScreenGui, {Name="MainFrame", BackgroundColor3=Colors.Background, Position=UDim2.new(0.5,-280,0.5,-200), Size=UDim2.new(0,560,0,400), Active=true, Draggable=true, Visible=false})
    AddCorner(MainFrame, 12); local ms = AddStroke(MainFrame, Colors.Accent, 1, 0.6); RegisterTheme(ms, "Color")
    local glow = Create("ImageLabel", MainFrame, {Name="Glow", AnchorPoint=Vector2.new(0.5,0.5), Position=UDim2.new(0.5,0,0.5,0), Size=UDim2.new(1,100,1,100), Image="rbxassetid://6014261993", ImageColor3=Colors.Accent, ImageTransparency=0.8, BackgroundTransparency=1, ZIndex=0})
    RegisterTheme(glow, "ImageColor3")

    local TopBar = Create("Frame", MainFrame, {Name="TopBar", BackgroundColor3=Colors.TopBar, Size=UDim2.new(1,0,0,50)})
    AddCorner(TopBar, 12); Create("Frame", TopBar, {Size=UDim2.new(1,0,0,20), Position=UDim2.new(0,0,1,-20), BackgroundColor3=Colors.TopBar, BorderSizePixel=0})
    Create("TextLabel", TopBar, {Text="GALAXY", Font="GothamBlack", TextColor3=Colors.Text, TextSize=18, Position=UDim2.new(0,20,0,0), Size=UDim2.new(0,100,1,0), BackgroundTransparency=1, TextXAlignment="Left"})
    local TabHolder = Create("Frame", TopBar, {Position=UDim2.new(0,130,0,0), Size=UDim2.new(1,-140,1,0), BackgroundTransparency=1})
    Create("UIListLayout", TabHolder, {FillDirection="Horizontal", SortOrder="LayoutOrder", Padding=UDim.new(0,10), VerticalAlignment="Center"})

    local ContentFrame = Create("Frame", MainFrame, {Name="Content", BackgroundColor3=Colors.Content, Position=UDim2.new(0,10,0,60), Size=UDim2.new(1,-20,1,-70)})
    AddCorner(ContentFrame, 8)
    
    local Tabs, TabHeights = {}, {}
    local function CreateTab(name)
        local btn = Create("TextButton", TabHolder, {Size=UDim2.new(0,80,0,30), BackgroundTransparency=1, Text=name, Font="GothamBold", TextColor3=Colors.TextDark, TextSize=13, AutoButtonColor = false})
        local underline = Create("Frame", btn, {Size=UDim2.new(0,0,0,2), Position=UDim2.new(0.5,0,1,2), BackgroundColor3=Colors.Accent, BorderSizePixel=0})
        AddCorner(underline, 1)
        local sc = Create("ScrollingFrame", ContentFrame, {Name=name.."Tab", Size=UDim2.new(1,-20,1,-20), Position=UDim2.new(0,10,0,10), BackgroundTransparency=1, CanvasSize=UDim2.new(0,0,0,0), ScrollBarThickness=2, ScrollBarImageColor3=Colors.Accent, Visible=false})
        TabHeights[sc] = 0
        local function Select()
            for _,t in pairs(Tabs) do t.Scroller.Visible=false Tween(t.Btn,{TextColor3=Colors.TextDark}) Tween(t.Und,{Size=UDim2.new(0,0,0,2),Position=UDim2.new(0.5,0,1,2)}) end
            sc.Visible=true Tween(btn,{TextColor3=Colors.Text}) Tween(underline,{Size=UDim2.new(1,0,0,2),Position=UDim2.new(0,0,1,2)})
        end
        btn.MouseButton1Click:Connect(Select)
        table.insert(Tabs, {Btn=btn, Scroller=sc, Und=underline})
        return sc
    end

    local TabCombat, TabVisuals, TabMovement, TabMisc, TabSettings = CreateTab("Combat"), CreateTab("Visuals"), CreateTab("Move"), CreateTab("Misc"), CreateTab("Settings")
    task.spawn(function() task.wait(0.1) if Tabs[1] then 
        Tabs[1].Scroller.Visible=true Tabs[1].Btn.TextColor3=Colors.Text 
        Tabs[1].Und.Size=UDim2.new(1,0,0,2) Tabs[1].Und.Position=UDim2.new(0,0,1,2) 
    end end)
    
    local function UpdateLayout(p, f)
        local y = TabHeights[p] or 5
        f.Position=UDim2.new(0,0,0,y) TabHeights[p]=y+f.Size.Y.Offset+6 p.CanvasSize=UDim2.new(0,0,0,TabHeights[p]+10)
    end

    local function AddComp(p, t, h)
        local f = Create("Frame", p, {Size=UDim2.new(1,0,0,h or 45), BackgroundColor3=Colors.Item})
        AddCorner(f,6); UpdateLayout(p,f)
        return f, Create("TextLabel", f, {Text=t, Font="GothamBold", TextColor3=Colors.Text, Size=UDim2.new(0.5,0,1,0), Position=UDim2.new(0,15,0,0), TextXAlignment="Left", TextSize=14, BackgroundTransparency=1})
    end

    local function AddToggle(parent, text, default, callback, id)
        local f, l = AddComp(parent, text)
        local sw = Create("Frame", f, {Size=UDim2.new(0,44,0,22), Position=UDim2.new(1,-60,0.5,-11), BackgroundColor3=Color3.fromRGB(45,48,54)})
        AddCorner(sw, 20); local kn = Create("Frame", sw, {Size=UDim2.new(0,18,0,18), Position=UDim2.new(0,2,0.5,-9), BackgroundColor3=Colors.Text})
        AddCorner(kn, 20); local btn = Create("TextButton", f, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text=""})
        local state = default
        local function Upd()
            local c = config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent
            Tween(sw, {BackgroundColor3 = state and c or Color3.fromRGB(45,48,54)})
            Tween(kn, {Position = state and UDim2.new(1,-20,0.5,-9) or UDim2.new(0,2,0.5,-9)})
            Tween(kn, {BackgroundColor3 = state and Color3.new(1,1,1) or Color3.fromRGB(100,100,100)})
        end
        RegisterTheme(sw, "BackgroundColor3") -- Register for dynamic updates
        local function Tog(v)
            state = v~=nil and v or not state; Upd(); UpdateHUD(text, state)
            local s = Create("Sound", game:GetService("SoundService"), {SoundId = state and "rbxassetid://4612375233" or "rbxassetid://4612377140", Volume=0.5}); s:Play(); s.Ended:Connect(function() s:Destroy() end)
            task.spawn(callback, state)
        end
        if default then UpdateHUD(text, true) end Upd()
        btn.MouseButton1Click:Connect(Tog)
        if id then
            btn.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton3 then
                l.Text=text.." ..."; l.TextColor3=Colors.Accent
                local c; c=Connect(UIS.InputBegan, function(k) if k.UserInputType==Enum.UserInputType.Keyboard then config.binds[id]=k.KeyCode; l.Text=text.." ["..k.KeyCode.Name.."]"; l.TextColor3=Colors.Text; c:Disconnect(); if RefreshKeyList then RefreshKeyList() end end end)
            end end)
            Connect(UIS.InputBegan, function(io,g) if not g and config.binds[id] and io.KeyCode==config.binds[id] then Tog() end end)
        end
    end

    local function AddSlider(parent, text, min, max, default, callback)
        local f, l = AddComp(parent, text, 60); l.Position=UDim2.new(0,15,0,12); l.Size=UDim2.new(0.5,0,0,20); l.TextSize=13
        local vl = Create("TextLabel", f, {Text=tostring(default), Font="GothamBold", TextColor3=Colors.Accent, Position=UDim2.new(1,-55,0,12), Size=UDim2.new(0,40,0,20), TextXAlignment="Right", TextSize=13, BackgroundTransparency=1})
        local sb = Create("Frame", f, {Size=UDim2.new(1,-30,0,4), Position=UDim2.new(0,15,0,42), BackgroundColor3=Color3.fromRGB(45,48,54)})
        AddCorner(sb,4); local fl = Create("Frame", sb, {Size=UDim2.new((default-min)/(max-min),0,1,0), BackgroundColor3=Colors.Accent})
        AddCorner(fl,4); local kn = Create("Frame", fl, {Size=UDim2.new(0,12,0,12), Position=UDim2.new(1,-6,0.5,-6), BackgroundColor3=Colors.Text})
        AddCorner(kn,10); local btn = Create("TextButton", f, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text=""})
        local function Upd(i)
            local p = math.clamp((i.Position.X-sb.AbsolutePosition.X)/sb.AbsoluteSize.X, 0, 1)
            local v = math.floor(min+((max-min)*p)); Tween(fl,{Size=UDim2.new(p,0,1,0)},.1); vl.Text=tostring(v); callback(v)
        end
        RegisterTheme(fl, "BackgroundColor3"); RegisterTheme(vl, "TextColor3")
        local drag = false; btn.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=true Upd(i) end end)
        Connect(UIS.InputChanged, function(i) if drag and i.UserInputType==Enum.UserInputType.MouseMovement then Upd(i) end end)
        Connect(UIS.InputEnded, function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=false end end)
    end

    local function AddDropdown(parent, text, options, callback)
        local f, l = AddComp(parent, text)
        local btn = Create("TextButton", f, {Size=UDim2.new(0,130,0,28), Position=UDim2.new(1,-145,0.5,-14), Text=options[1], BackgroundColor3=Color3.fromRGB(45,48,54), TextColor3=Colors.Text, Font="GothamBold", TextSize=12})
        AddCorner(btn,6); local s = AddStroke(btn, Colors.Accent,1,0.7); RegisterTheme(s, "Color"); local idx=1
        btn.MouseButton1Click:Connect(function() idx=idx<#options and idx+1 or 1; btn.Text=options[idx]; callback(options[idx]) end)
    end

    local function AddButton(parent, text, callback)
        local f, btn = AddComp(parent, ""); btn:Destroy()
        btn = Create("TextButton", f, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text=text, Font="GothamBold", TextColor3=Colors.Text, TextSize=14})
        btn.MouseEnter:Connect(function() Tween(f,{BackgroundColor3=Colors.Hover}) end)
        btn.MouseLeave:Connect(function() Tween(f,{BackgroundColor3=Colors.Item}) end)
        btn.MouseButton1Click:Connect(callback)
    end

    local function AddBind(p, t, i) AddToggle(p, t, false, function() end, i) end

    -- // ULTIMATE UNIVERSAL SCANNER (HYBRID) //
    local TargetCache = {} -- Used for NPCs/Entities in "All" mode
    local PlayerCache = {} -- Used for Players (Instant update)

    -- Efficient Player Tracking
    local function AddPlayer(player)
        local function CharAdded(char)
            PlayerCache[player] = char
        end
        if player.Character then CharAdded(player.Character) end
        Connect(player.CharacterAdded, CharAdded)
    end
    
    -- Track new and existing players
    Connect(Players.PlayerAdded, function(p) if p ~= LP then AddPlayer(p) end end)
    for _, p in pairs(Players:GetPlayers()) do 
        if p ~= LP then AddPlayer(p) end 
    end
    Connect(Players.PlayerRemoving, function(p) PlayerCache[p] = nil end)

    -- Optimized NPC/Entity Scanner (Runs less frequently)
    local function ScanForNPCs()
        local list = {}
        if config.espMode == "All" then
            for _, v in pairs(workspace:GetDescendants()) do 
                if v:IsA("Humanoid") and v.Parent and v.Health > 0 then
                    local char = v.Parent
                    -- Exclude real players from this list to avoid double counting
                    if not Players:GetPlayerFromCharacter(char) and char ~= LP.Character then
                        table.insert(list, char)
                    end
                end
            end
        end
        return list
    end

    task.spawn(function()
        while ScreenGui.Parent do
           TargetCache = ScanForNPCs()
           task.wait(1.5)
        end
    end)

    -- Unified Target Iterator
    local function GetTargets()
        local t = {}
        -- Always add players first (High Priority)
        if config.espMode == "Players" or config.espMode == "All" then
            for _, char in pairs(PlayerCache) do table.insert(t, char) end
        end
        -- Add NPCs if mode is All
        if config.espMode == "All" then
            for _, char in pairs(TargetCache) do table.insert(t, char) end
        end
        return t
    end

    -- // CORE COMBAT //
    local function getBestPart(char) return char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso") end
    local function isVisible(part) 
        if not config.wallCheck then return true end
        local p = RaycastParams.new()
        p.FilterDescendantsInstances = {LP.Character, Camera, ScreenGui}
        p.FilterType = Enum.RaycastFilterType.Exclude
        local r = workspace:Raycast(Camera.CFrame.Position, part.Position - Camera.CFrame.Position, p)
        return not r or r.Instance:IsDescendantOf(part.Parent)
    end

    Connect(RS.RenderStepped, function()
        local char = LP.Character; if not char or not char:FindFirstChild("Humanoid") then return end
        local hum = char.Humanoid
        if config.walkSpeed > 16 then hum.WalkSpeed = config.walkSpeed end
        if config.jumpPower > 50 then hum.JumpPower = config.jumpPower end
        if config.bhop and hum.MoveDirection.Magnitude > 0 and UIS:IsKeyDown(Enum.KeyCode.Space) then if hum.FloorMaterial ~= Enum.Material.Air then hum.Jump = true; local r = char:FindFirstChild("HumanoidRootPart"); if r then r.Velocity += hum.MoveDirection * 5 end end end
        if config.noclip then for _,v in pairs(char:GetDescendants()) do if v:IsA("BasePart") then v.CanCollide = false end end end
        if config.antiAim then local r = char:FindFirstChild("HumanoidRootPart"); if r then r.CFrame *= CFrame.Angles(0, math.rad(100), 0) * CFrame.Angles(math.rad(math.random(-20,20)), 0, 0) end end
        if config.infAmmo then for _,v in pairs(char:GetDescendants()) do if v:IsA("IntValue") or v:IsA("NumberValue") then local n = v.Name:lower(); if n=="ammo" or n=="clip" or n=="mag" then v.Value = 999 end end end end
        
        -- ESP & CHAMS SYNC
        for _,c in pairs(GetTargets()) do
            if c and c.Parent and c:FindFirstChild("HumanoidRootPart") and c:FindFirstChild("Humanoid") and c.Humanoid.Health>0 then
                -- Chams (Highlights)
                if config.chams then
                    local h = c:FindFirstChild("G_Chams") or Create("Highlight", c, {Name="G_Chams", FillColor=Color3.new(1,0,0), FillTransparency=0.5, OutlineColor=Color3.new(1,1,1), OutlineTransparency=0, DepthMode=Enum.HighlightDepthMode.AlwaysOnTop})
                    h.Enabled = true; h.FillColor = config.theme=="Rainbow" and rainbowColor or Color3.new(1,0,0)
                elseif c:FindFirstChild("G_Chams") then c.G_Chams:Destroy() end
                
                -- Boxes
                if config.boxEsp then
                    local b = c:FindFirstChild("G_Box") or Create("BillboardGui", c, {Name="G_Box", Size=UDim2.new(4,0,5.5,0), AlwaysOnTop=true})
                    local f = b:FindFirstChild("Frame") or Create("Frame", b, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1})
                    local s = f:FindFirstChild("Inline") or Create("UIStroke", f, {Name="Inline", Thickness=1, Color=config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent})
                    s.Color = config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent
                else if c:FindFirstChild("G_Box") then c.G_Box:Destroy() end end
                
                -- Tracers
                if config.tracers and char:FindFirstChild("HumanoidRootPart") and char.HumanoidRootPart:FindFirstChild("G_Att_L") then
                    local b = c:FindFirstChild("G_Beam") or Create("Beam", c, {Name="G_Beam", Attachment0=char.HumanoidRootPart.G_Att_L, Attachment1=c.HumanoidRootPart:FindFirstChild("G_Att") or Create("Attachment", c.HumanoidRootPart, {Name="G_Att"}), FaceCamera=true, Width0=0.2, Width1=0.2})
                    b.Color = ColorSequence.new(config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent)
                else if c:FindFirstChild("G_Beam") then c.G_Beam:Destroy() end end
            else
                if c:FindFirstChild("G_Box") then c.G_Box:Destroy() end
                if c:FindFirstChild("G_Beam") then c.G_Beam:Destroy() end
                if c:FindFirstChild("G_Chams") then c.G_Chams:Destroy() end
            end
        end

        if aimEnabled then
            local best, minDist = nil, config.fovSize
            local mousePos = Vector2.new(Mouse.X, Mouse.Y)
            -- Use Unified Target List
            local targets = GetTargets()
            
            for _, char in pairs(targets) do
                if char and char.Parent and char ~= LP.Character and char:FindFirstChildOfClass("Humanoid") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                    local part = getBestPart(char)
                    if part then
                        local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                        if onScreen then
                            local d = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                            if d < minDist and isVisible(part) then best = char; minDist = d end
                        end
                    end
                end
            end
            if best then
                local part = getBestPart(best); local pos = part.Position
                if config.usePrediction and best:FindFirstChild("HumanoidRootPart") then 
                    pos = pos + (best.HumanoidRootPart.Velocity * config.predictionFactor) 
                end
                
                local targetCF = CFrame.lookAt(Camera.CFrame.Position, pos)
                if config.aimSmoothing > 1 then
                    Camera.CFrame = Camera.CFrame:Lerp(targetCF, 0.25 / config.aimSmoothing) -- Faster Lerp base
                else
                    Camera.CFrame = targetCF
                end
            end
        end

        -- TRIGGERBOT 3.0 (RAPID FIRE)
        if triggerEnabled then
            local p = RaycastParams.new(); p.FilterDescendantsInstances = {LP.Character, Camera, ScreenGui}; p.FilterType = Enum.RaycastFilterType.Exclude
            -- Reduced radius to 1.5 for "Crosshair" feeling (Precise but forgiving)
            local s, h = pcall(function() return workspace:Spherecast(Camera.CFrame.Position, 1.5, Camera.CFrame.LookVector * 1000, p) end)
            
            -- Simplified Check: Does it have a Humanoid?
            local isEnemy = false
            if s and h and h.Instance then
                local m = h.Instance:FindFirstAncestorOfClass("Model") or h.Instance.Parent
                if m and m:FindFirstChildOfClass("Humanoid") and m ~= LP.Character then isEnemy = true end
            end
            
            if isEnemy then
                 -- RAPID FIRE LOGIC (Supports Semi-Auto & Auto)
                 if VIM then
                    VIM:SendMouseButtonEvent(0,0,0,true,game,0)
                    VIM:SendMouseButtonEvent(0,0,0,false,game,0)
                 elseif mouse1click then
                    mouse1click()
                 elseif mouse1press then
                    mouse1press(); mouse1release()
                 end
            end
        end

        -- China Hat Logic
        if config.chinaHat and char:FindFirstChild("Head") then
            local hat = char.Head:FindFirstChild("G_ChinaHat") or Create("ConeHandleAdornment", char.Head, {
                Name = "G_ChinaHat", Adornee = char.Head, Height = 0.6, Radius = 1.0, 
                Transparency = 0.4, AlwaysOnTop = true, ZIndex = 10,
                CFrame = CFrame.new(0, 0.4, 0) * CFrame.Angles(math.rad(90), 0, 0)
            })
            hat.Color3 = config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent
        elseif char:FindFirstChild("Head") and char.Head:FindFirstChild("G_ChinaHat") then
            char.Head.G_ChinaHat:Destroy()
        end
    end)

    -- // VISUALS //
    local espEnabled = false
    -- // VISUALS ENGINE (v7.6 BEAMS & BOXES) //
    local function ClearVisuals(char)
        if char:FindFirstChild("G_Box") then char.G_Box:Destroy() end
        if char:FindFirstChild("G_Beam") then char.G_Beam:Destroy() end
        if char:FindFirstChild("G_Att") then char.G_Att:Destroy() end
        if char:FindFirstChild("G_Chams") then char.G_Chams:Destroy() end
        if char:FindFirstChild("Head") and char.Head:FindFirstChild("G_ChinaHat") then char.Head.G_ChinaHat:Destroy() end
    end

    -- // BINDING // 
    AddToggle(TabCombat, "Aimbot", false, function(s) aimEnabled = s end, "aim")
    AddToggle(TabCombat, "TriggerBot", false, function(s) triggerEnabled = s end, "trig")
    AddToggle(TabCombat, "Knife Aura", false, function(s) config.knifeBot = s end, "knife")
    AddSlider(TabCombat, "Knife Range", 5, 30, 15, function(v) config.knifeRange = v end)
    AddToggle(TabCombat, "No Recoil", false, function(s) config.noRecoil = s end)
    AddSlider(TabCombat, "Smoothing", 1, 10, 1, function(v) config.aimSmoothing = v end)
    AddToggle(TabCombat, "Inf Ammo", false, function(s) config.infAmmo = s end, "ammo")
    AddToggle(TabCombat, "Wall Check", config.wallCheck, function(s) config.wallCheck = s end)
    
    AddToggle(TabVisuals, "ESP", false, function(s) espEnabled = s end, "esp")
    AddToggle(TabVisuals, "Chams", false, function(s) config.chams = s end)
    AddToggle(TabVisuals, "China Hat", false, function(s) config.chinaHat = s end)
    AddToggle(TabVisuals, "Show FOV", config.showFov, function(s) config.showFov = s end)
    AddToggle(TabVisuals, "Tracers", false, function(s) config.tracers = s end)
    AddToggle(TabVisuals, "Box ESP", false, function(s) config.boxEsp = s end)
    AddDropdown(TabVisuals, "Scan Mode", {"All", "Players"}, function(v) config.espMode = v end)

    AddToggle(TabMisc, "NoClip", false, function(s) config.noclip = s end, "noclip")
    AddToggle(TabMisc, "FE Invisibility", false, function(s)
        config.invisibility = s
        if s and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            local r = LP.Character.HumanoidRootPart; local p = r.CFrame; LP.Character:MoveTo(seatTeleportPosition); task.wait(0.1)
            currentSeat = Create("Seat", workspace, {Name="invischair", Transparency=1, CanCollide=false, Position=seatTeleportPosition})
            local w = Create("Weld", currentSeat, {Part0=currentSeat, Part1=LP.Character:FindFirstChild("Torso") or LP.Character:FindFirstChild("UpperTorso")}); task.wait(); currentSeat.CFrame = p
        elseif currentSeat then currentSeat:Destroy(); currentSeat = nil end
    end, "invis")
    AddToggle(TabMisc, "Rage AA", false, function(s) config.antiAim = s end, "aa")
    AddToggle(TabMisc, "Speed BHop", false, function(s) config.bhop = s end, "bhop")
    AddSlider(TabMisc, "Speed", 16, 200, 16, function(v) config.walkSpeed = v end)
    AddSlider(TabMisc, "Jump", 50, 300, 50, function(v) config.jumpPower = v end)
    
    -- CUSTOM THIRD PERSON (ShiftLock Style)
    local CamRot = Vector2.new(0,0)
    AddToggle(TabMisc, "Third Person", false, function(s) 
        config.thirdPerson = s 
        if s then RS:BindToRenderStep("G_TP", 201, function() if MainFrame.Visible then UIS.MouseBehavior = "Default" return end UIS.MouseBehavior = "LockCenter" local d = UIS:GetMouseDelta(); CamRot -= d*0.005; CamRot = Vector2.new(CamRot.X, math.clamp(CamRot.Y, -1.4, 1.4)) if LP.Character and LP.Character:FindFirstChild("Head") then Camera.CFrame = CFrame.new(LP.Character.Head.Position) * CFrame.Angles(0, CamRot.X, 0) * CFrame.Angles(CamRot.Y, 0, 0) * CFrame.new(2, 2, config.thirdPersonDist) end end)
        else RS:UnbindFromRenderStep("G_TP") UIS.MouseBehavior = "Default" end
    end, "tp")
    AddSlider(TabMisc, "TP Dist", 10, 50, 20, function(v) config.thirdPersonDist = v end)
    
    AddToggle(TabMisc, "Fly Mode [F]", false, function(s)
        local root = LP.Character.HumanoidRootPart
        if s then
            local bg = Instance.new("BodyGyro", root); bg.maxTorque = Vector3.new(math.huge,math.huge,math.huge); bg.P = 10000; bg.D = 1000; bg.Name = "FlyG"
            local bv = Instance.new("BodyVelocity", root); bv.maxForce = Vector3.new(math.huge,math.huge,math.huge); bv.Name = "FlyV"
            LP.Character.Humanoid.PlatformStand = true
            
            -- Main Fly Loop
            local c; c = RS.RenderStepped:Connect(function()
                 if not s or not root.Parent or not root:FindFirstChild("FlyV") then c:Disconnect(); return end
                 local speed = 65
                 if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then speed = 120 end
                 
                 local d = Vector3.new()
                 if UIS:IsKeyDown(Enum.KeyCode.W) then d = d + Camera.CFrame.LookVector end
                 if UIS:IsKeyDown(Enum.KeyCode.S) then d = d - Camera.CFrame.LookVector end
                 if UIS:IsKeyDown(Enum.KeyCode.A) then d = d - Camera.CFrame.RightVector end
                 if UIS:IsKeyDown(Enum.KeyCode.D) then d = d + Camera.CFrame.RightVector end
                 
                 -- Vertical Logic
                 if UIS:IsKeyDown(Enum.KeyCode.Space) then d = d + Vector3.new(0, 1, 0) end
                 if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then d = d - Vector3.new(0, 1, 0) end
                 
                 bv.Velocity = d * speed
                 bg.CFrame = Camera.CFrame
            end)
            table.insert(Connections, c) -- Track for Unload
        else
            if LP.Character and LP.Character:FindFirstChild("Humanoid") then
                LP.Character.Humanoid.PlatformStand = false
            end
            if root:FindFirstChild("FlyG") then root.FlyG:Destroy() end
            if root:FindFirstChild("FlyV") then root.FlyV:Destroy() end
        end
    end)
    
    -- // MOVEMENT (TELEPORTS) //
    local function getHRP()
        return LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
    end
    local TeleportGui = Create("Frame", ScreenGui, {Name="TeleportGui", Size=UDim2.new(0,180,0,170), Position=UDim2.new(0,20,0,0.6), BackgroundColor3=Colors.Background, Visible=false, Active=true, Draggable=true})
    AddCorner(TeleportGui, 10); local tks = AddStroke(TeleportGui, Colors.Accent, 1, 0.6); RegisterTheme(tks, "Color")
    local TH = Create("Frame", TeleportGui, {Size=UDim2.new(1,0,0,30), BackgroundColor3=Colors.TopBar}); AddCorner(TH, 10)
    Create("Frame", TH, {Size=UDim2.new(1,0,0,10), Position=UDim2.new(0,0,1,-10), BackgroundColor3=Colors.TopBar, BorderSizePixel=0})
    Create("TextLabel", TH, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text="Teleports", Font="GothamBlack", TextColor3=Colors.Text, TextSize=12})
    
    local TC = Create("Frame", TeleportGui, {Name="Container", Size=UDim2.new(1,0,1,-35), Position=UDim2.new(0,0,0,35), BackgroundTransparency=1})
    Create("UIListLayout", TC, {Padding=UDim.new(0,5), HorizontalAlignment="Center", VerticalAlignment="Top"})
    Create("UIPadding", TC, {PaddingTop=UDim.new(0,5)})

    local function makeMiniBtn(txt, callback)
        local b = Create("TextButton", TC, {Size=UDim2.new(0.9,0,0,26), BackgroundColor3=Colors.Item, Text=txt, Font="GothamBold", TextColor3=Colors.Colors and Colors.Text or Color3.new(1,1,1), TextSize=11})
        AddCorner(b, 6); local s = AddStroke(b, Colors.Accent, 1, 0.4); RegisterTheme(s, "Color")
        b.MouseButton1Click:Connect(callback)
        return b
    end

    local s1 = makeMiniBtn("Save Position 1", function()
        local hrp = getHRP()
        if hrp then TP1 = hrp.CFrame; pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY", Text="Pos 1 Saved!", Duration=2}) end) end
    end)
    local t1 = makeMiniBtn("Teleport 1 [B]", function()
        local hrp = getHRP()
        if hrp and TP1 then hrp.CFrame = TP1 end
    end)
    local s2 = makeMiniBtn("Save Position 2", function()
        local hrp = getHRP()
        if hrp then TP2 = hrp.CFrame; pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY", Text="Pos 2 Saved!", Duration=2}) end) end
    end)
    local t2 = makeMiniBtn("Teleport 2 [N]", function()
        local hrp = getHRP()
        if hrp and TP2 then hrp.CFrame = TP2 end
    end)

    AddToggle(TabMovement, "Teleport GUI", false, function(s) TeleportGui.Visible = s end)
    AddButton(TabMovement, "Save Position 1", function()
        local hrp = getHRP()
        if hrp then 
            TP1 = hrp.CFrame
            pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY", Text="Position 1 Saved!", Duration=2}) end)
        end
    end)
    AddButton(TabMovement, "Teleport 1  [B]", function()
        local hrp = getHRP()
        if hrp and TP1 then hrp.CFrame = TP1 end
    end)
    AddButton(TabMovement, "Save Position 2", function()
        local hrp = getHRP()
        if hrp then 
            TP2 = hrp.CFrame
            pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY", Text="Position 2 Saved!", Duration=2}) end)
        end
    end)
    AddButton(TabMovement, "Teleport 2  [N]", function()
        local hrp = getHRP()
        if hrp and TP2 then hrp.CFrame = TP2 end
    end)

    Connect(UIS.InputBegan, function(input, g)
        if g then return end
        if input.KeyCode == Enum.KeyCode.B then
            local hrp = getHRP()
            if hrp and TP1 then hrp.CFrame = TP1 end
        elseif input.KeyCode == Enum.KeyCode.N then
            local hrp = getHRP()
            if hrp and TP2 then hrp.CFrame = TP2 end
        end
    end)
    
    -- TP handled by BindToRenderStep now

    local function AddKeybind(parent, text, default, id)
        local f = Create("Frame", parent, {Size=UDim2.new(1,-6,0,40), BackgroundColor3=Colors.Item})
        AddCorner(f,6); UpdateLayout(parent,f)
        local l = Create("TextLabel", f, {Text=text.." ["..(default and default.Name or "None").."]", Font="GothamBold", TextColor3=Colors.Text, BackgroundTransparency=1, Size=UDim2.new(1,-20,1,0), Position=UDim2.new(0,12,0,0), TextXAlignment="Left", TextSize=13})
        local btn = Create("TextButton", f, {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text=""})
        btn.MouseButton1Click:Connect(function() l.Text = text.." ..."; l.TextColor3 = Color3.new(1,1,0)
            local c; c = Connect(UIS.InputBegan, function(k) if k.UserInputType==Enum.UserInputType.Keyboard then config[id]=k.KeyCode; l.Text=text.." ["..k.KeyCode.Name.."]"; l.TextColor3=Colors.Text; c:Disconnect(); if RefreshKeyList then RefreshKeyList() end end end)
        end)
    end

    -- // HUD //
    local KeyList = Create("Frame", ScreenGui, {Name="KeyList", Position=UDim2.new(1,-200,0.4,0), Size=UDim2.new(0,180,0,30), BackgroundColor3=Colors.Background, Visible=config.keybindList, Draggable=true, Active=true})
    AddCorner(KeyList); local ks = AddStroke(KeyList, Colors.Accent, 1, 0.6); RegisterTheme(ks, "Color")
    local KH = Create("Frame", KeyList, {Size=UDim2.new(1,0,0,28), BackgroundColor3=Colors.TopBar}); AddCorner(KH)
    Create("Frame", KH, {Size=UDim2.new(1,0,0,10), Position=UDim2.new(0,0,1,-10), BackgroundColor3=Colors.TopBar, BorderSizePixel=0})
    Create("TextLabel", KH, {Text="  Keybinds", Font="GothamBlack", TextColor3=Colors.Text, Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, TextSize=12, TextXAlignment="Left"})
    local KC = Create("Frame", KeyList, {Position=UDim2.new(0,0,0,30), Size=UDim2.new(1,0,1,-30), BackgroundTransparency=1})
    Create("UIListLayout", KC, {Padding=UDim.new(0,4)})
    Create("UIPadding", KC, {PaddingTop=UDim.new(0,5), PaddingLeft=UDim.new(0,10), PaddingRight=UDim.new(0,10)})

    RefreshKeyList = function()
        for _,c in pairs(KC:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
        local function AddE(n,k) if not k then return end local f = Create("Frame", KC, {Size=UDim2.new(1,0,0,20), BackgroundTransparency=1})
            Create("TextLabel", f, {Text=n, Font="GothamBold", TextSize=12, TextColor3=Colors.Text, Size=UDim2.new(0.6,0,1,0), BackgroundTransparency=1, TextXAlignment="Left"})
            Create("TextLabel", f, {Text="["..k.Name.."]", Font="GothamBold", TextSize=12, TextColor3=Colors.Accent, Size=UDim2.new(0.4,0,1,0), Position=UDim2.new(0.6,0,0,0), BackgroundTransparency=1, TextXAlignment="Right"})
        end
        AddE("Menu", config.menuKey); AddE("Aimbot", config.aimKey)
        for id,k in pairs(config.binds) do AddE(id:upper(), k) end
        local i = 0; for _,v in pairs(KC:GetChildren()) do if v:IsA("Frame") then i += 1 end end
        KeyList.Size = UDim2.new(0,180,0,30+(i*24)+10)
    end
    RefreshKeyList()
    
    -- Hook into Theme Update
    Connect(RS.RenderStepped, function()
        if config.theme=="Rainbow" then
            Watermark.TextColor3 = rainbowColor; if WF:FindFirstChild("UIStroke") then WF.UIStroke.Color = rainbowColor end
            if KeyList.Visible then if KeyList:FindFirstChild("UIStroke") then KeyList.UIStroke.Color = rainbowColor end end
            for _,f in pairs(ArrayList:GetChildren()) do if f:IsA("Frame") then if f:FindFirstChild("UIStroke") then f.UIStroke.Color = rainbowColor end f:FindFirstChildOfClass("TextLabel").TextColor3 = rainbowColor end end
        end
    end)

    AddToggle(TabSettings, "Show Keybinds", config.keybindList, function(s) KeyList.Visible = s end)
    AddDropdown(TabSettings, "Theme", {"Rainbow", "Purple", "Blue", "Red"}, function(v) if Themes[v] then CurrentTheme=Themes[v]; config.theme=v end end)
    AddKeybind(TabSettings, "Menu Key", config.menuKey, "menuKey")
    AddKeybind(TabSettings, "Aimbot Bind", config.aimKey, "aimKey")
    AddKeybind(TabSettings, "Trigger Bind", config.triggerKey, "triggerKey")
    
    -- Explicit Function Binds (Refresh HUD on change)
    AddBind(TabSettings, "ESP Toggle", "esp")
    AddBind(TabSettings, "Fly Toggle", "fly")
    AddBind(TabSettings, "NoClip Toggle", "noclip")
    AddBind(TabSettings, "Third Person Toggle", "tp")
    AddBind(TabSettings, "Anti-Aim Toggle", "aa")
    AddBind(TabSettings, "Tracers Toggle", "trace")
    AddBind(TabSettings, "Speed BHop Toggle", "bhop")
    AddBind(TabSettings, "KnifeBot Toggle", "knife")
    
    
    local function AddButton(parent, text, callback)
        local f = Instance.new("Frame", parent)
        f.Size = UDim2.new(1, -6, 0, 40)
        f.BackgroundColor3 = Colors.Item
        AddCorner(f, 6)
        UpdateLayout(parent, f)
        
        local btn = Instance.new("TextButton", f)
        btn.Size = UDim2.new(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text = text
        btn.Font = Enum.Font.GothamBold
        btn.TextColor3 = Colors.Text
        btn.TextSize = 13
        
        btn.MouseEnter:Connect(function() Tween(f, {BackgroundColor3 = Colors.Hover}) end)
        btn.MouseLeave:Connect(function() Tween(f, {BackgroundColor3 = Colors.Item}) end)
        btn.MouseButton1Click:Connect(callback)
    end
    
    -- // DEEP SERIALIZATION (Fixes Config Saving) //
    local function Serialize(tbl)
        local res = {}
        for k, v in pairs(tbl) do
            if type(v) == "table" then
                res[k] = Serialize(v)
            elseif typeof(v) == "EnumItem" then
                res[k] = {__ENUM = tostring(v)}
            else
                res[k] = v
            end
        end
        return res
    end
    
    local function Deserialize(tbl)
        local res = {}
        for k, v in pairs(tbl) do
            if type(v) == "table" then
                if v.__ENUM then
                     -- Parse Enum string "Enum.KeyCode.E"
                     local parts = v.__ENUM:split(".") -- {"Enum", "KeyCode", "E"}
                     res[k] = Enum[parts[2]][parts[3]]
                else
                     res[k] = Deserialize(v)
                end
            else
                res[k] = v
            end
        end
        return res
    end

    AddButton(TabSettings, "Save Config", function()
        local data = Serialize(config)
        writefile("galaxy_cfg.json", HttpService:JSONEncode(data))
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Saved Successfully", Duration = 2})
    end)
    
    AddButton(TabSettings, "Load Config", function()
        if isfile("galaxy_cfg.json") then
            local data = HttpService:JSONDecode(readfile("galaxy_cfg.json"))
            local loaded = Deserialize(data)
            for k, v in pairs(loaded) do
                config[k] = v
            end
            RefreshKeyList() -- Update UI
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Loaded!", Duration = 3})
        end
    end)

    AddButton(TabSettings, "Clear Config", function() ResetConfig(); RefreshKeyList() end)
    AddButton(TabSettings, "UNLOAD CHEAT", function()
        -- 1. Disconnect all events
        for _, c in pairs(Connections) do c:Disconnect() end
        RS:UnbindFromRenderStep("G_TP") 
        
        -- 2. Deep Clean ESP from Workspace
        for _, p in pairs(Players:GetPlayers()) do
            if p.Character then ClearVisuals(p.Character) end
        end
        for _, v in pairs(workspace:GetDescendants()) do
            if v.Name == "G_Box" or v.Name == "G_Beam" or v.Name == "G_Att" or v.Name == "invischair" or v.Name == "G_ChinaHat" then
                pcall(function() v:Destroy() end)
            end
        end
        
        -- 3. Reset Character State
        if LP.Character then
            if LP.Character:FindFirstChild("Humanoid") then
                LP.Character.Humanoid.PlatformStand = false
                LP.Character.Humanoid.WalkSpeed = 16
                LP.Character.Humanoid.JumpPower = 50
            end
            for _, v in pairs(LP.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = true end
            end
        end

        -- 4. Destroy UI
        ScreenGui:Destroy()
        if KeySystemGui then KeySystemGui:Destroy() end
        
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY", Text = "Fully Cleared & Unloaded", Duration = 3})
    end)

    -- // ANIMATED MENU CONTROLS //
    MainFrame.Size = UDim2.new(0, 0, 0, 0)
    MainFrame.BackgroundTransparency = 1
    MainFrame.Visible = false
    
    local isMenuOpen = false
    local function ToggleMenu()
        isMenuOpen = not isMenuOpen; MainFrame.Visible = true
        MainFrame:TweenSize(isMenuOpen and UDim2.new(0,560,0,400) or UDim2.new(0,0,0,0), "Out", "Quint", 0.3, true)
        Tween(MainFrame, {BackgroundTransparency = isMenuOpen and 0 or 1}, 0.3)
        if not isMenuOpen then task.delay(0.3, function() MainFrame.Visible=false end) end
    end
    local OpenBtn = Create("TextButton", ScreenGui, {Size=UDim2.new(0,44,0,44), Position=UDim2.new(0,20,0.5,-22), BackgroundColor3=Colors.TopBar, Text="G", Font="GothamBlack", TextColor3=Colors.Accent, TextSize=22})
    AddCorner(OpenBtn,10); AddStroke(OpenBtn, Colors.Accent, 2, 0.5); OpenBtn.MouseButton1Click:Connect(ToggleMenu)
    Connect(UIS.InputBegan, function(i,g) if not g and (config.menuKey and i.KeyCode==config.menuKey or i.KeyCode==Enum.KeyCode.RightShift) then ToggleMenu() end end)
    local Circ = Create("Frame", ScreenGui, {BackgroundTransparency=1}); local CS = AddStroke(Circ, Colors.Accent, 2); AddCorner(Circ, 100)
    Connect(RS.RenderStepped, function()
        Circ.Visible = config.showFov and aimEnabled; Circ.Position = UDim2.new(0, Mouse.X-config.fovSize, 0, Mouse.Y-config.fovSize); Circ.Size = UDim2.new(0, config.fovSize*2, 0, config.fovSize*2); CS.Color = config.theme=="Rainbow" and rainbowColor or CurrentTheme.Accent
        if isMenuOpen then UIS.MouseBehavior = "Default"; UIS.MouseIconEnabled = true end
    end)
    
    game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY X", Text = "Cyber Slate v11 Loaded", Duration = 5})
end


KeyBtn.MouseButton1Click:Connect(function() 
    if KeyBox.Text == "2026" then writefile("galaxy.auth", HS:JSONEncode({key="2026", timestamp=os.time()})); KeySystemGui:Destroy(); LoadGalaxy() else KeyBtn.Text = "Invalid!" task.delay(2, function() KeyBtn.Text="Login" end) end 
end)
