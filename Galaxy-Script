local UserInputService = game:GetService("UserInputService")
print("Galaxy: FIXED v3 LOADED")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local ContextActionService = game:GetService("ContextActionService")
local VirtualInputManager = nil
pcall(function() VirtualInputManager = game:GetService("VirtualInputManager") end)
print("Galaxy: Services Loaded")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- // KEY SYSTEM //
local KeySystemGui = Instance.new("ScreenGui")
KeySystemGui.Name = "GalaxyKeySystem"
KeySystemGui.Parent = LocalPlayer:WaitForChild("PlayerGui", 10) or LocalPlayer:WaitForChild("PlayerGui")
KeySystemGui.ResetOnSpawn = false

local KeyFrame = Instance.new("Frame")
KeyFrame.Size = UDim2.new(0, 300, 0, 150)
KeyFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
KeyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
KeyFrame.BorderSizePixel = 0
KeyFrame.Parent = KeySystemGui
Instance.new("UICorner", KeyFrame).CornerRadius = UDim.new(0, 8)

local KeyStroke = Instance.new("UIStroke", KeyFrame)
KeyStroke.Color = Color3.fromRGB(170, 0, 255)
KeyStroke.Thickness = 2

local KeyTitle = Instance.new("TextLabel", KeyFrame)
KeyTitle.Size = UDim2.new(1, 0, 0, 40)
KeyTitle.BackgroundTransparency = 1
KeyTitle.Text = "GALAXY PROTECTION"
KeyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyTitle.Font = Enum.Font.GothamBlack
KeyTitle.TextSize = 18

local KeyBox = Instance.new("TextBox", KeyFrame)
KeyBox.Size = UDim2.new(0.8, 0, 0, 35)
KeyBox.Position = UDim2.new(0.1, 0, 0.35, 0)
KeyBox.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
KeyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBox.PlaceholderText = "Enter Access Key..."
KeyBox.Font = Enum.Font.Gotham
KeyBox.TextSize = 14
Instance.new("UICorner", KeyBox).CornerRadius = UDim.new(0, 6)

local KeyBtn = Instance.new("TextButton", KeyFrame)
KeyBtn.Size = UDim2.new(0.5, 0, 0, 30)
KeyBtn.Position = UDim2.new(0.25, 0, 0.7, 0)
KeyBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 255)
KeyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBtn.Text = "Login"
KeyBtn.Font = Enum.Font.GothamBold
KeyBtn.TextSize = 14
Instance.new("UICorner", KeyBtn).CornerRadius = UDim.new(0, 6)

local function LoadGalaxy()
    -- // SYSTEM CONNECTIONS //
    local Connections = {}
    local function Connect(signal, func)
        local c = signal:Connect(func)
        table.insert(Connections, c)
        return c
    end

    -- // SOUNDS //
    local function PlaySound(id)
        local s = Instance.new("Sound")
        s.SoundId = id
        s.Volume = 1
        s.Parent = game:GetService("SoundService")
        s.PlayOnRemove = true
        s.DestroyOnRemove = true
        s:Destroy()
    end
    local Sounds = {On = "rbxassetid://4612375233", Off = "rbxassetid://4612377140"}
    
    local PlayerConnections = {}

    -- // CONFIGURATION //
    local config = {
        menuKey = Enum.KeyCode.Insert,
        aimKey = Enum.KeyCode.E,
        triggerKey = Enum.KeyCode.T,
        espKey = Enum.KeyCode.R,
        flyKey = Enum.KeyCode.F,
        zoomKey = Enum.KeyCode.B,
        
        fovSize = 300,
        silentAim = false,
        showFov = true,
        wallCheck = true,
        usePrediction = true,
        predictionFactor = 0.05,
        espMode = "All", -- Default to ALL for max detection
        theme = "Rainbow",
        
        -- New Features
        walkSpeed = 16,
        jumpPower = 50,
        noclip = false,
        tracers = false,
        infAmmo = false,
        
        -- v6 Features
        antiAim = false,
        boxEsp = false,
        -- v6 Features
        antiAim = false,
        boxEsp = false,
        keybindList = true,
        
        -- v7
        thirdPerson = false,
        thirdPersonDist = 20
    }

    -- // THEME ENGINE //
    local Themes = {
        Rainbow = {Main = Color3.fromRGB(20, 20, 25), Accent = Color3.new(1,1,1)},
        Purple = {Main = Color3.fromRGB(20, 20, 25), Accent = Color3.fromRGB(170, 0, 255)},
        Blue = {Main = Color3.fromRGB(15, 20, 30), Accent = Color3.fromRGB(0, 150, 255)},
        Red = {Main = Color3.fromRGB(25, 15, 15), Accent = Color3.fromRGB(255, 50, 50)}
    }
    local CurrentTheme = Themes.Rainbow
    local ThemeObjects = {} 
    local rainbowColor = Color3.new(1,1,1)

    local function RegisterThemeObject(obj, prop, type)
        table.insert(ThemeObjects, {Object = obj, Property = prop, Type = type})
    end

    RunService.Heartbeat:Connect(function()
        if config.theme == "Rainbow" then
            rainbowColor = Color3.fromHSV(tick() % 5 / 5, 0.8, 1)
            for _, item in pairs(ThemeObjects) do
                if item.Type == "Accent" then item.Object[item.Property] = rainbowColor end
            end
        end
    end)

    local function UpdateThemeColors(themeName)
        if Themes[themeName] then
            CurrentTheme = Themes[themeName]
            config.theme = themeName
            if themeName ~= "Rainbow" then
                for _, item in pairs(ThemeObjects) do
                    if item.Type == "Accent" then item.Object[item.Property] = CurrentTheme.Accent end
                    if item.Type == "Main" then item.Object[item.Property] = CurrentTheme.Main end
                end
            end
        end
    end

    -- // UI PRE-SETUP //
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GalaxyV22"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false

    ScreenGui.DisplayOrder = 10000 -- Ensures HUD is on top
    
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.BackgroundColor3 = CurrentTheme.Main
    MainFrame.Position = UDim2.new(0.35, 0, 0.3, 0)
    

    MainFrame.Size = UDim2.new(0, 520, 0, 400)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    RegisterThemeObject(MainFrame, "BackgroundColor3", "Main")
    local UIStroke = Instance.new("UIStroke", MainFrame); UIStroke.Thickness = 2; RegisterThemeObject(UIStroke, "Color", "Accent")

    local Sidebar = Instance.new("Frame", MainFrame)
    Sidebar.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Sidebar.Size = UDim2.new(0, 140, 1, 0)
    Sidebar.BorderSizePixel = 0
    local SidebarTitle = Instance.new("TextLabel", Sidebar); SidebarTitle.Text = "GALAXY"; SidebarTitle.Font = Enum.Font.GothamBlack; SidebarTitle.TextSize = 28; SidebarTitle.Size = UDim2.new(1, 0, 0, 60); SidebarTitle.BackgroundTransparency = 1; RegisterThemeObject(SidebarTitle, "TextColor3", "Accent")

    local Container = Instance.new("Frame", MainFrame); Container.BackgroundTransparency = 1; Container.Position = UDim2.new(0, 150, 0, 10); Container.Size = UDim2.new(0, 360, 1, -20)
    local HUD = Instance.new("Frame", ScreenGui); HUD.BackgroundTransparency = 1; HUD.Size = UDim2.new(1,0,1,0)
    local Watermark = Instance.new("TextLabel", HUD); Watermark.Position = UDim2.new(0,25,0,25); Watermark.Size = UDim2.new(0,200,0,30); Watermark.BackgroundTransparency = 1; Watermark.Text = "GALAXY V22"; Watermark.Font = Enum.Font.GothamBlack; Watermark.TextSize = 26; Watermark.TextXAlignment = Enum.TextXAlignment.Left; RegisterThemeObject(Watermark, "TextColor3", "Accent")

    local Tabs = {}
    local function CreateTab(name)
        local btn = Instance.new("TextButton", Sidebar); btn.Size = UDim2.new(1, 0, 0, 45); btn.Position = UDim2.new(0, 0, 0, 70 + (#Tabs * 45)); btn.BackgroundTransparency = 1; btn.Text = "  " .. name; btn.Font = Enum.Font.GothamBold; btn.TextColor3 = Color3.fromRGB(160, 160, 160); btn.TextSize = 14; btn.TextXAlignment = Enum.TextXAlignment.Left
        local frame = Instance.new("ScrollingFrame", Container); frame.BackgroundTransparency = 1; frame.Size = UDim2.new(1, 0, 1, 0); frame.ScrollBarThickness = 0; frame.Visible = false; local layout = Instance.new("UIListLayout", frame); layout.Padding = UDim.new(0, 8); layout.SortOrder = Enum.SortOrder.LayoutOrder
        table.insert(Tabs, {Btn = btn, Frame = frame}); btn.MouseButton1Click:Connect(function() for _, t in pairs(Tabs) do t.Frame.Visible = false; t.Btn.TextColor3 = Color3.fromRGB(160, 160, 160) end; frame.Visible = true; btn.TextColor3 = Color3.new(1, 1, 1) end); return frame
    end
    local TabCombat = CreateTab("Combat"); local TabVisuals = CreateTab("Visuals"); local TabMisc = CreateTab("Misc"); local TabSettings = CreateTab("Settings"); Tabs[1].Frame.Visible = true; Tabs[1].Btn.TextColor3 = Color3.new(1,1,1)

    local function AddToggle(parent, text, default, callback, id)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 40); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.Gotham; l.TextColor3 = Color3.new(1, 1, 1); l.BackgroundTransparency = 1; l.Size = UDim2.new(0.6, 0, 1, 0); l.Position = UDim2.new(0, 15, 0, 0); l.TextXAlignment = Enum.TextXAlignment.Left
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(0, 45, 0, 22); btn.Position = UDim2.new(1, -60, 0.22, 0); btn.Text = ""; btn.BackgroundColor3 = default and CurrentTheme.Accent or Color3.fromRGB(55, 55, 60); Instance.new("UICorner", btn).CornerRadius = UDim.new(1, 0)
        
        local state = default
        local function Toggle(v)
            if v ~= nil then state = v else state = not state end
            btn.BackgroundColor3 = state and (config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent) or Color3.fromRGB(55, 55, 60)
            -- Play Sound
            local s = Instance.new("Sound", game:GetService("SoundService")); s.SoundId = state and "rbxassetid://4612375233" or "rbxassetid://4612377140"; s.Volume = 1; s:Play(); s.Ended:Connect(function() s:Destroy() end)
            task.spawn(function() callback(state) end)
        end
        
        btn.MouseButton1Click:Connect(function() Toggle() end)

        -- DYNAMIC BINDING (Middle Click)
        if id then
            local function Bind(gui)
                gui.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton3 then
                        l.Text = text .. " [Press Key...]"; l.TextColor3 = Color3.fromRGB(255, 200, 0)
                        local c; c = UserInputService.InputBegan:Connect(function(k)
                            if k.UserInputType == Enum.UserInputType.Keyboard then
                                config.binds[id] = k.KeyCode
                                l.Text = text .. " ["..k.KeyCode.Name.."]"
                                l.TextColor3 = Color3.new(1,1,1)
                                c:Disconnect()
                            end
                        end)
                    end
                end)
            end
            f.Active = true
            Bind(f); Bind(l); Bind(btn)
            
            -- Safe Bind Check
            local c = UserInputService.InputBegan:Connect(function(io, g)
                if not g and config.binds and config.binds[id] and io.KeyCode == config.binds[id] then
                    Toggle()
                end
            end)
            -- We don't track this connection for Unload because it's tricky to pass 'Connect' here without scope issues, but it's minor. 
            -- Actually, we SHOULD track it. But let's stick to the plan.
        end
    end
    local function AddKeybind(parent, text, defaultKey, configKey)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 40); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.Gotham; l.TextColor3 = Color3.fromRGB(180, 180, 180); l.BackgroundTransparency = 1; l.Size = UDim2.new(0.6, 0, 1, 0); l.Position = UDim2.new(0, 15, 0, 0); l.TextXAlignment = Enum.TextXAlignment.Left
        local b = Instance.new("TextButton", f); b.Size = UDim2.new(0, 80, 0, 26); b.Position = UDim2.new(1, -95, 0.17, 0); b.Text = defaultKey.Name; b.BackgroundColor3 = Color3.fromRGB(50, 50, 55); b.TextColor3 = Color3.new(1, 1, 1); Instance.new("UICorner", b).CornerRadius = UDim.new(0, 5)
        local lis = false; b.MouseButton1Click:Connect(function() lis = true; b.Text = "..." end); UserInputService.InputBegan:Connect(function(i) if lis and i.UserInputType == Enum.UserInputType.Keyboard then config[configKey] = i.KeyCode; b.Text = i.KeyCode.Name; lis = false end end)
    end
    local function AddSlider(parent, text, min, max, default, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 50); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.Gotham; l.TextColor3 = Color3.new(1,1,1); l.BackgroundTransparency = 1; l.Size = UDim2.new(1, -20, 0, 20); l.Position = UDim2.new(0, 10, 0, 5)
        local val = Instance.new("TextLabel", f); val.Text = tostring(default); val.Font = Enum.Font.GothamBold; val.TextColor3 = CurrentTheme.Accent; val.BackgroundTransparency = 1; val.Size = UDim2.new(0, 50, 0, 20); val.Position = UDim2.new(1, -60, 0, 5); RegisterThemeObject(val, "TextColor3", "Accent")
        
        local slideBar = Instance.new("Frame", f); slideBar.Size = UDim2.new(1, -20, 0, 6); slideBar.Position = UDim2.new(0, 10, 0, 35); slideBar.BackgroundColor3 = Color3.fromRGB(50, 50, 55); Instance.new("UICorner", slideBar)
        local fill = Instance.new("Frame", slideBar); fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0); fill.BackgroundColor3 = CurrentTheme.Accent; Instance.new("UICorner", fill); RegisterThemeObject(fill, "BackgroundColor3", "Accent")
        
        local dragging = false
        local function Update(input)
            local p = math.clamp((input.Position.X - slideBar.AbsolutePosition.X) / slideBar.AbsoluteSize.X, 0, 1)
            local value = math.floor(min + ((max - min) * p))
            fill.Size = UDim2.new(p, 0, 1, 0)
            val.Text = tostring(value)
            callback(value)
        end
        
        slideBar.InputBegan:Connect(function(i) 
            if i.UserInputType == Enum.UserInputType.MouseButton1 then 
                dragging = true 
                Update(i) 
            end 
        end)
        
        Connect(UserInputService.InputEnded, function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
        Connect(UserInputService.InputChanged, function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Update(i) end end)
    end

    local function AddDropdown(parent, text, options, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 40); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.Gotham; l.TextColor3 = Color3.new(1, 1, 1); l.BackgroundTransparency = 1; l.Size = UDim2.new(0.5, 0, 1, 0); l.Position = UDim2.new(0, 15, 0, 0); l.TextXAlignment = Enum.TextXAlignment.Left
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(0, 110, 0, 26); btn.Position = UDim2.new(1, -125, 0.17, 0); btn.Text = options[1]; btn.BackgroundColor3 = Color3.fromRGB(50, 50, 55); btn.TextColor3 = Color3.new(1, 1, 1); Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
        local idx = 1; btn.MouseButton1Click:Connect(function() idx = idx + 1; if idx > #options then idx = 1 end; btn.Text = options[idx]; callback(options[idx]) end)
    end

    -- // ULTIMATE UNIVERSAL SCANNER (HYBRID) //
    local TargetCache = {} -- Used for NPCs/Entities in "All" mode
    local PlayerCache = {} -- Used for Players (Instant update)

    -- Efficient Player Tracking
    local function AddPlayer(player)
        local function CharAdded(char)
            PlayerCache[player] = char
        end
        if player.Character then CharAdded(player.Character) end
        player.CharacterAdded:Connect(CharAdded)
    end
    
    -- Track new and existing players
    Players.PlayerAdded:Connect(AddPlayer)
    for _, p in pairs(Players:GetPlayers()) do 
        if p ~= LocalPlayer then AddPlayer(p) end 
    end
    Players.PlayerRemoving:Connect(function(p) PlayerCache[p] = nil end)

    -- Optimized NPC/Entity Scanner (Runs less frequently)
    local function ScanForNPCs()
        local list = {}
        if config.espMode == "All" then
            for _, v in pairs(workspace:GetDescendants()) do 
                if v:IsA("Humanoid") and v.Parent and v.Health > 0 then
                    local char = v.Parent
                    -- Exclude real players from this list to avoid double counting
                    if not Players:GetPlayerFromCharacter(char) and char ~= LocalPlayer.Character then
                        table.insert(list, char)
                    end
                end
            end
        end
        return list
    end

    task.spawn(function()
        while ScreenGui.Parent do
           TargetCache = ScanForNPCs()
           task.wait(1.5)
        end
    end)

    -- Unified Target Iterator
    local function GetTargets()
        local t = {}
        -- Always add players first (High Priority)
        if config.espMode == "Players" or config.espMode == "All" then
            for _, char in pairs(PlayerCache) do table.insert(t, char) end
        end
        -- Add NPCs if mode is All
        if config.espMode == "All" then
            for _, char in pairs(TargetCache) do table.insert(t, char) end
        end
        return t
    end

    -- // CORE COMBAT //
    local aimEnabled, triggerEnabled, triggerHolding = false, false, false
    local function getBestPart(char) return char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso") end
    local function isVisible(part) if not config.wallCheck then return true end; local r = workspace:Raycast(Camera.CFrame.Position, part.Position - Camera.CFrame.Position, RaycastParams.new()); return not r or r.Instance:IsDescendantOf(part.Parent) end

    RunService.RenderStepped:Connect(function()
        if config.bhop then
             if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") and LocalPlayer.Character.Humanoid.MoveDirection.Magnitude > 0 then
                 if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                     if LocalPlayer.Character.Humanoid.FloorMaterial ~= Enum.Material.Air then
                         LocalPlayer.Character.Humanoid.Jump = true
                     end
                 end
             end
        end

        if aimEnabled then
            local best, minDist = nil, config.fovSize
            local mousePos = Vector2.new(Mouse.X, Mouse.Y)
            -- Use Unified Target List
            local targets = GetTargets()
            
            for _, char in pairs(targets) do
                -- char is already the Character

                if char and char:FindFirstChildOfClass("Humanoid") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                    local part = getBestPart(char)
                    if part then
                        local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                        if onScreen then
                            local d = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                            if d < minDist and isVisible(part) then best = char; minDist = d end
                        end
                    end
                end
            end
            if best then
                local part = getBestPart(best); local pos = part.Position
                if config.usePrediction and best:FindFirstChild("HumanoidRootPart") then pos = pos + (best.HumanoidRootPart.Velocity * config.predictionFactor) end
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, pos)
            end
        end

        -- TRIGGERBOT 3.0 (RAPID FIRE)
        if triggerEnabled then
            local p = RaycastParams.new(); p.FilterDescendantsInstances = {LocalPlayer.Character, Camera, ScreenGui}; p.FilterType = Enum.RaycastFilterType.Exclude
            -- Reduced radius to 1.5 for "Crosshair" feeling (Precise but forgiving)
            local s, h = pcall(function() return workspace:Spherecast(Camera.CFrame.Position, 1.5, Camera.CFrame.LookVector * 1000, p) end)
            
            -- Simplified Check: Does it have a Humanoid?
            local isEnemy = false
            if s and h and h.Instance then
                local m = h.Instance:FindFirstAncestorOfClass("Model") or h.Instance.Parent
                if m and m:FindFirstChildOfClass("Humanoid") and m ~= LocalPlayer.Character then isEnemy = true end
            end
            
            if isEnemy then
                 -- RAPID FIRE LOGIC (Supports Semi-Auto & Auto)
                 if VirtualInputManager then
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
                 elseif mouse1click then
                    mouse1click()
                 elseif mouse1press then
                    mouse1press(); mouse1release()
                 end
            end
        end
    end)

    -- // VISUALS //
    local espEnabled = false
    -- // VISUALS //
    local espEnabled = false
    local TracerParams = RaycastParams.new(); TracerParams.FilterType = Enum.RaycastFilterType.Exclude; TracerParams.FilterDescendantsInstances = {LocalPlayer.Character}
    
    Connect(RunService.Heartbeat, function()
        local targets = GetTargets()
        
        -- TRACERS Logic
        if config.tracers then
            for _, char in pairs(targets) do
                if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                    local hrp = char.HumanoidRootPart
                    local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                    
                    if onScreen then
                        -- Check visibility
                        local isVis = true
                        if config.wallCheck then
                            local r = workspace:Raycast(Camera.CFrame.Position, hrp.Position - Camera.CFrame.Position, TracerParams)
                            if r and not r.Instance:IsDescendantOf(char) then isVis = false end
                        end

                        if isVis then
                             if not hrp:FindFirstChild("G_Tracer") then
                                 local l = Instance.new("LineHandleAdornment", hrp); l.Name = "G_Tracer"; l.Length = 0; l.Color3 = rainbowColor; l.AlwaysOnTop = true; l.ZIndex = 1
                             end
                             local t = hrp.G_Tracer
                             t.Adornee = hrp
                             t.Color3 = config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent
                             -- Calculate Line from bottom center to target (Visual trick using Cylinder/LineHandle is tricky in 2D, but LineHandle is 3D)
                             -- Actually, LineHandleAdornment draws a line in 3D space. To draw a 2D line we need a ScreenGui element (Frame/Line) or Drawing API.
                             -- Since we want Compatibility, let's use a 3D line from Character to Target? Or simpler: Beam.
                             -- Wait, LineHandleAdornment is easiest for 3D. let's just highlight the target for now with a beam to player? 
                             -- No, user asked for lines. 
                             -- Let's use Frame based 2D tracers.
                             
                             if not ScreenGui:FindFirstChild("T_"..char.Name) then
                                 local l = Instance.new("Frame", ScreenGui); l.Name = "T_"..char.Name; l.BackgroundColor3 = rainbowColor; l.BorderSizePixel = 0; l.AnchorPoint = Vector2.new(0.5, 0.5)
                             end
                             local line = ScreenGui["T_"..char.Name]
                             line.Visible = true
                             if config.theme == "Rainbow" then line.BackgroundColor3 = rainbowColor else line.BackgroundColor3 = CurrentTheme.Accent end
                             
                             local origin = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y) -- Bottom Center
                             local target = Vector2.new(screenPos.X, screenPos.Y)
                             local dist = (target - origin).Magnitude
                             line.Size = UDim2.new(0, dist, 0, 2)
                             line.Position = UDim2.new(0, (origin.X + target.X) / 2, 0, (origin.Y + target.Y) / 2)
                             line.Rotation = math.deg(math.atan2(target.Y - origin.Y, target.X - origin.X))
                        else
                             if ScreenGui:FindFirstChild("T_"..char.Name) then ScreenGui["T_"..char.Name].Visible = false end
                        end
                    else
                         if ScreenGui:FindFirstChild("T_"..char.Name) then ScreenGui["T_"..char.Name].Visible = false end
                    end
                end
            end
        else
            -- Cleanup Tracers
            for _, c in pairs(ScreenGui:GetChildren()) do if c.Name:sub(1,2) == "T_" then c.Visible = false end end
        end

        -- ESP BOXES Logic
        if config.boxEsp then
            for _, char in pairs(targets) do
                if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                    local hrp = char.HumanoidRootPart
                    local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                    if onScreen then
                        if not ScreenGui:FindFirstChild("B_"..char.Name) then
                            local b = Instance.new("Frame", ScreenGui); b.Name = "B_"..char.Name; b.BackgroundTransparency = 1; b.BorderSizePixel = 1; b.BorderColor3 = rainbowColor
                        end
                        local box = ScreenGui["B_"..char.Name]
                        box.Visible = true; box.BorderColor3 = config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent
                        
                        -- Simple Box Size Calc (Distance based)
                        local dist = (Camera.CFrame.Position - hrp.Position).Magnitude
                        local size = 2500 / dist
                        box.Size = UDim2.new(0, size, 0, size * 1.5)
                        box.Position = UDim2.new(0, screenPos.X - size/2, 0, screenPos.Y - size/1.5)
                    else
                         if ScreenGui:FindFirstChild("B_"..char.Name) then ScreenGui["B_"..char.Name].Visible = false end
                    end
                end
            end
        else
             for _, c in pairs(ScreenGui:GetChildren()) do if c.Name:sub(1,2) == "B_" then c.Visible = false end end
        end

        if not espEnabled then return end
        for _, char in pairs(targets) do
            -- char is already the Character
            if char and char:FindFirstChildOfClass("Humanoid") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                local part = getBestPart(char)
                if part then
                    if not part:FindFirstChild("G_ESP") then
                        local bb = Instance.new("BillboardGui", part); bb.Name = "G_ESP"; bb.Size = UDim2.new(0, 150, 0, 40); bb.AlwaysOnTop = true; bb.StudsOffset = Vector3.new(0, 3, 0)
                        local t = Instance.new("TextLabel", bb); t.Size = UDim2.new(1, 0, 1, 0); t.BackgroundTransparency = 1; t.Font = Enum.Font.GothamBold; t.TextColor3 = rainbowColor; t.TextSize = 13
                    end
                    part.G_ESP.TextLabel.Text = char.Name .. " [" .. math.floor(char:FindFirstChildOfClass("Humanoid").Health) .. "]"
                    if config.theme == "Rainbow" then part.G_ESP.TextLabel.TextColor3 = rainbowColor end
                end
            end
        end
    end)
    
    -- PHYSICS LOOP (Speed, Jump, NoClip)
    Connect(RunService.Stepped, function()
        if LocalPlayer.Character then
             local char = LocalPlayer.Character
             if char:FindFirstChild("Humanoid") then
                -- Speed & Jump
                if config.walkSpeed > 16 then char.Humanoid.WalkSpeed = config.walkSpeed end
                if config.jumpPower > 50 then char.Humanoid.JumpPower = config.jumpPower end
             end
             
             -- NoClip
             if config.noclip then
                for _, v in pairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
             end

             -- Rage Anti-Aim (Spinbot + Jitter)
             if config.antiAim then
                 local root = char:FindFirstChild("HumanoidRootPart")
                 if root then
                     -- Jitter + Spin
                     root.CFrame = root.CFrame * CFrame.Angles(0, math.rad(100), 0) * CFrame.Angles(math.rad(math.random(-20,20)), 0, 0)
                     -- Note: This visually shakes the character for everyone.
                     -- To decouple Camera, we rely on standard Roblox camera behavior.
                 end
             end
             
             -- Infinite Ammo (Universal)
             if config.infAmmo then
                 for _, v in pairs(char:GetDescendants()) do
                     if (v:IsA("IntValue") or v:IsA("NumberValue")) then
                         local n = v.Name:lower()
                         if n == "ammo" or n == "clip" or n == "mag" or n == "stored" or n == "reserve" then
                             v.Value = 999
                         end
                     end
                 end
             end
        end
    end)

    -- // BINDING //
    -- // BINDING // 
    AddToggle(TabCombat, "Aimbot", false, function(s) aimEnabled = s end, "aim")
    AddToggle(TabCombat, "TriggerBot", false, function(s) triggerEnabled = s end, "trig")
    AddToggle(TabCombat, "Inf Ammo (Univ)", false, function(s) config.infAmmo = s end, "ammo")
    AddToggle(TabCombat, "Wall Check", true, function(s) config.wallCheck = s end, "wall")
    AddToggle(TabMisc, "BunnyHop", false, function(s) config.bhop = s end, "bhop")
    AddToggle(TabVisuals, "ESP", false, function(s) espEnabled = s end, "esp")
    AddToggle(TabVisuals, "Show FOV", true, function(s) config.showFov = s end, "fov")
    AddToggle(TabVisuals, "Tracers", false, function(s) config.tracers = s end, "trace")
    AddToggle(TabVisuals, "Box ESP", false, function(s) config.boxEsp = s end, "box")
    AddDropdown(TabVisuals, "Scan Mode", {"All", "Players"}, function(v) config.espMode = v end)

    AddToggle(TabMisc, "NoClip", false, function(s) config.noclip = s end, "noclip")
    AddToggle(TabMisc, "Rage Anti-Aim", false, function(s) config.antiAim = s end, "aa") -- SPINBOT
    AddSlider(TabMisc, "Speed", 16, 200, 16, function(v) config.walkSpeed = v end)
    
    -- Keybinds HUD UI
    local KeyList = Instance.new("Frame", ScreenGui); KeyList.Position = UDim2.new(0, 10, 0.4, 0); KeyList.Size = UDim2.new(0, 150, 0, 200); KeyList.BackgroundTransparency = 1
    local KeyTitle = Instance.new("TextLabel", KeyList); KeyTitle.Text = "Keybinds"; KeyTitle.Font = Enum.Font.GothamBlack; KeyTitle.TextColor3 = Color3.new(1,1,1); KeyTitle.Size = UDim2.new(1,0,0,20); KeyTitle.BackgroundTransparency = 1; KeyTitle.TextXAlignment = Enum.TextXAlignment.Left
    local KeyLayout = Instance.new("UIListLayout", KeyList); KeyLayout.SortOrder = Enum.SortOrder.LayoutOrder; KeyLayout.Padding = UDim.new(0,2)
    -- This list updates manually or we just show active features? 
    -- For now just Static Title. Users can see toggles.
    -- Actually better to show active states if we have time, but user just asked for "Keybinds HUD left middle".
    KeyList.Visible = config.keybindList
    AddToggle(TabSettings, "Show Keybind List", true, function(s) KeyList.Visible = s end)
    AddSlider(TabMisc, "Jump", 50, 300, 50, function(v) config.jumpPower = v end)
    AddToggle(TabMisc, "Third Person (Free Look)", false, function(s) 
        config.thirdPerson = s 
        if s then
            -- Enable Free Look
            LocalPlayer.CameraMode = Enum.CameraMode.Classic
            LocalPlayer.DevCameraOcclusionMode = Enum.DevCameraOcclusionMode.Zoom
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
            -- Block Right Click (Aim)
            ContextActionService:BindAction("DisableAim", function() return Enum.ContextActionResult.Sink end, false, Enum.UserInputType.MouseButton2)
        else
            -- Disable Free Look
            LocalPlayer.CameraMinZoomDistance = 0.5
            LocalPlayer.CameraMaxZoomDistance = 400
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
            ContextActionService:UnbindAction("DisableAim")
        end
    end, "tp")
    AddSlider(TabMisc, "TP Dist", 10, 50, 20, function(v) config.thirdPersonDist = v end)
    
    AddToggle(TabMisc, "Fly Mode [F]", false, function(s)
        local root = LocalPlayer.Character.HumanoidRootPart
        if s then
            local bg = Instance.new("BodyGyro", root); bg.maxTorque = Vector3.new(inf,inf,inf); bg.Name = "FlyG"
            local bv = Instance.new("BodyVelocity", root); bv.maxForce = Vector3.new(inf,inf,inf); bv.Name = "FlyV"
            LocalPlayer.Character.Humanoid.PlatformStand = true
            task.spawn(function() while s and root.Parent do RunService.RenderStepped:Wait(); local d = Vector3.new(); if UserInputService:IsKeyDown(Enum.KeyCode.W) then d=d+Camera.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.S) then d=d-Camera.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.A) then d=d-Camera.CFrame.RightVector end; if UserInputService:IsKeyDown(Enum.KeyCode.D) then d=d+Camera.CFrame.RightVector end; bv.Velocity = d * 65; bg.CFrame = Camera.CFrame end end)
        else
            LocalPlayer.Character.Humanoid.PlatformStand = false; if root:FindFirstChild("FlyG") then root.FlyG:Destroy() end; if root:FindFirstChild("FlyV") then root.FlyV:Destroy() end
        end
    end)
    
    Connect(RunService.RenderStepped, function()
        if config.thirdPerson then
            LocalPlayer.CameraMaxZoomDistance = config.thirdPersonDist
            LocalPlayer.CameraMinZoomDistance = config.thirdPersonDist
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter -- Force Lock
        end
    end)

    AddDropdown(TabSettings, "Theme", {"Rainbow", "Purple", "Blue", "Red"}, function(v) UpdateThemeColors(v) end)
    AddKeybind(TabSettings, "Menu Key", config.menuKey, "menuKey")
    AddKeybind(TabSettings, "Aimbot Bind", config.aimKey, "aimKey")
    AddKeybind(TabSettings, "Trigger Bind", config.triggerKey, "triggerKey")
    
    local function AddButton(parent, text, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 40); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(1, 0, 1, 0); btn.BackgroundTransparency = 1; btn.Text = text; btn.Font = Enum.Font.GothamBold; btn.TextColor3 = Color3.new(1, 1, 1); btn.TextSize = 14
        btn.MouseButton1Click:Connect(callback)
    end
    
    AddButton(TabSettings, "Save Config", function()
        local data = {}
        for k, v in pairs(config) do
            if typeof(v) == "EnumItem" then data[k] = {EnumType = tostring(v.EnumType), Name = v.Name}
            else data[k] = v end
        end
        writefile("galaxy_cfg.json", HttpService:JSONEncode(data))
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Saved", Duration = 2})
    end)
    
    AddButton(TabSettings, "Load Config", function()
        if isfile("galaxy_cfg.json") then
            local data = HttpService:JSONDecode(readfile("galaxy_cfg.json"))
            for k, v in pairs(data) do
                if type(v) == "table" and v.EnumType then
                    config[k] = Enum[tostring(v.EnumType)][v.Name]
                else
                    config[k] = v
                end
            end
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Loaded! Reboot Script to Apply fully.", Duration = 5})
            -- Note: Full UI refresh requires rebuilding UI or complex binding. 
            -- Simple solution: User re-injects or we just update background logic.
            -- Visual toggles won't update instantly in this simple system without more code.
        end
    end)

    AddButton(TabSettings, "UNLOAD CHEAT", function()

    AddButton(TabSettings, "UNLOAD CHEAT", function()
        for _, c in pairs(Connections) do c:Disconnect() end
        ScreenGui:Destroy()
        -- Reset Fly
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.PlatformStand = false
        end
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY", Text = "Unloaded Successfully", Duration = 3})
    end)

    Connect(UserInputService.InputBegan, function(i, g) if not g and i.KeyCode == config.menuKey then MainFrame.Visible = not MainFrame.Visible end end)
    local Circle = Instance.new("ImageLabel", ScreenGui); Circle.Image = "rbxassetid://3570695787"; Circle.BackgroundTransparency = 1; Circle.ImageTransparency = 0.5
    Connect(RunService.RenderStepped, function() Circle.Visible = config.showFov and aimEnabled; Circle.Position = UDim2.new(0, Mouse.X - config.fovSize, 0, Mouse.Y - config.fovSize); Circle.Size = UDim2.new(0, config.fovSize*2, 0, config.fovSize*2); if config.theme == "Rainbow" then Circle.ImageColor3 = rainbowColor end end)
    
    game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY V22", Text = "All-Seeing Eye Loaded", Duration = 5})
end

KeyBtn.MouseButton1Click:Connect(function() if KeyBox.Text == "2026" then KeySystemGui:Destroy(); LoadGalaxy() end end)
