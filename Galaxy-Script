local UserInputService = game:GetService("UserInputService")
print("Galaxy: FIXED v3 LOADED")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local ContextActionService = game:GetService("ContextActionService")
local VirtualInputManager = nil
pcall(function() VirtualInputManager = game:GetService("VirtualInputManager") end)
print("Galaxy: Services Loaded")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- // KEY SYSTEM //
local KeySystemGui = Instance.new("ScreenGui")
KeySystemGui.Name = "GalaxyKeySystem"
KeySystemGui.Parent = LocalPlayer:WaitForChild("PlayerGui", 10) or LocalPlayer:WaitForChild("PlayerGui")
KeySystemGui.ResetOnSpawn = false

local KeyFrame = Instance.new("Frame")
KeyFrame.Size = UDim2.new(0, 300, 0, 150)
KeyFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
KeyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
KeyFrame.BorderSizePixel = 0
KeyFrame.Parent = KeySystemGui
Instance.new("UICorner", KeyFrame).CornerRadius = UDim.new(0, 8)

local KeyStroke = Instance.new("UIStroke", KeyFrame)
KeyStroke.Color = Color3.fromRGB(170, 0, 255)
KeyStroke.Thickness = 2

local KeyTitle = Instance.new("TextLabel", KeyFrame)
KeyTitle.Size = UDim2.new(1, 0, 0, 40)
KeyTitle.BackgroundTransparency = 1
KeyTitle.Text = "GALAXY PROTECTION"
KeyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyTitle.Font = Enum.Font.GothamBlack
KeyTitle.TextSize = 18

local KeyBox = Instance.new("TextBox", KeyFrame)
KeyBox.Size = UDim2.new(0.8, 0, 0, 35)
KeyBox.Position = UDim2.new(0.1, 0, 0.35, 0)
KeyBox.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
KeyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBox.PlaceholderText = "Enter Access Key..."
KeyBox.Font = Enum.Font.Gotham
KeyBox.TextSize = 14
Instance.new("UICorner", KeyBox).CornerRadius = UDim.new(0, 6)

local KeyBtn = Instance.new("TextButton", KeyFrame)
KeyBtn.Size = UDim2.new(0.5, 0, 0, 30)
KeyBtn.Position = UDim2.new(0.25, 0, 0.7, 0)
KeyBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 255)
KeyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBtn.Text = "Login"
KeyBtn.Font = Enum.Font.GothamBold
KeyBtn.TextSize = 14
Instance.new("UICorner", KeyBtn).CornerRadius = UDim.new(0, 6)

local function LoadGalaxy()
    -- // SYSTEM CONNECTIONS //
    local Connections = {}
    local function Connect(signal, func)
        local c = signal:Connect(func)
        table.insert(Connections, c)
        return c
    end

    -- // SOUNDS //
    local function PlaySound(id)
        local s = Instance.new("Sound")
        s.SoundId = id
        s.Volume = 1
        s.Parent = game:GetService("SoundService")
        s.PlayOnRemove = true
        s.DestroyOnRemove = true
        s:Destroy()
    end
    local Sounds = {On = "rbxassetid://4612375233", Off = "rbxassetid://4612377140"}
    
    local PlayerConnections = {}
    local RefreshKeyList -- Forward Declaration for UI updates

    -- // CONFIGURATION //
    local config = {
        menuKey = Enum.KeyCode.Insert,
        aimKey = Enum.KeyCode.E,
        triggerKey = Enum.KeyCode.T,
        espKey = Enum.KeyCode.R,
        flyKey = Enum.KeyCode.F,
        zoomKey = Enum.KeyCode.B,
        
        fovSize = 300,
        silentAim = false,
        showFov = true,
        wallCheck = true,
        usePrediction = true,
        predictionFactor = 0.05,
        espMode = "All", -- Default to ALL for max detection
        theme = "Rainbow",
        
        -- New Features
        walkSpeed = 16,
        jumpPower = 50,
        noclip = false,
        tracers = false,
        infAmmo = false,
        
        -- v6 Features
        antiAim = false,
        boxEsp = false,
        -- v6 Features
        antiAim = false,
        boxEsp = false,
        keybindList = true,
        
        -- v7
        thirdPerson = false,
        -- v7
        thirdPerson = false,
        thirdPersonDist = 20,
        
        -- v8.1 KnifeBot
        knifeBot = false,
        knifeRange = 15,
        
        -- v8.3 No Recoil
        noRecoil = false,
        
        -- Internal Binds Storage
        binds = {}
    }

    -- // THEME ENGINE //
    local Themes = {
        Rainbow = {Main = Color3.fromRGB(20, 20, 25), Accent = Color3.fromRGB(0, 255, 150)}, -- Default to Mint/Neon
        Purple = {Main = Color3.fromRGB(20, 20, 25), Accent = Color3.fromRGB(170, 0, 255)},
        Blue = {Main = Color3.fromRGB(15, 20, 30), Accent = Color3.fromRGB(0, 150, 255)},
        Red = {Main = Color3.fromRGB(25, 15, 15), Accent = Color3.fromRGB(255, 50, 50)}
    }
    local CurrentTheme = Themes.Rainbow
    local ThemeObjects = {} 
    
    local TweenService = game:GetService("TweenService")
    local function Tween(obj, props, time)
        TweenService:Create(obj, TweenInfo.new(time or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
    end

    -- // LOGIC LOOPS //
    
    -- NO RECOIL (Universal)
    local function SilenceGun(tool)
        if not config.noRecoil then return end
        for _, v in pairs(tool:GetDescendants()) do
            if v:IsA("ModuleScript") then
                local success, module = pcall(require, v)
                if success and type(module) == "table" then
                    -- Common Recoil Keys in Roblox FPS frameworks
                    local keys = {"Recoil", "RecoilMin", "RecoilMax", "Spread", "SpreadMin", "SpreadMax", "Kick", "CameraShake", "Shake"}
                    for _, key in pairs(keys) do
                        if module[key] then module[key] = 0 end
                    end
                end
            elseif v:IsA("NumberValue") and (v.Name:lower():find("recoil") or v.Name:lower():find("spread")) then
                v.Value = 0
            end
        end
    end
    
    Connect(RunService.Stepped, function()
        if config.noRecoil and LocalPlayer.Character then
            local tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
            if tool then
                SilenceGun(tool)
            end
        end
    end)
    
    -- KNIFEBOT LOGIC
    Connect(RunService.Stepped, function()
        if config.knifeBot and LocalPlayer.Character then
            local tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
            if tool then
                local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if myRoot then
                    local closest = nil
                    local minDst = config.knifeRange
                    for _, p in pairs(Players:GetPlayers()) do
                        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
                            local dist = (p.Character.HumanoidRootPart.Position - myRoot.Position).Magnitude
                            if dist < minDst then
                                minDst = dist
                                closest = p.Character.HumanoidRootPart
                            end
                        end
                    end
                    
                    if closest then
                        -- Face Target (Instant match Y rotation)
                        local lookPos = Vector3.new(closest.Position.X, myRoot.Position.Y, closest.Position.Z)
                        myRoot.CFrame = CFrame.lookAt(myRoot.Position, lookPos)
                        -- Activate
                        tool:Activate()
                    end
                end
            end
        end
    end)
 
    local rainbowColor = Color3.new(1,1,1)

    local function RegisterThemeObject(obj, prop, type)
        table.insert(ThemeObjects, {Object = obj, Property = prop, Type = type})
    end

    RunService.Heartbeat:Connect(function()
        if config.theme == "Rainbow" then
            rainbowColor = Color3.fromHSV(tick() % 5 / 5, 0.8, 1)
            for _, item in pairs(ThemeObjects) do
                if item.Type == "Accent" then item.Object[item.Property] = rainbowColor end
            end
        end
    end)

    local function UpdateThemeColors(themeName)
        if Themes[themeName] then
            CurrentTheme = Themes[themeName]
            config.theme = themeName
            if themeName ~= "Rainbow" then
                for _, item in pairs(ThemeObjects) do
                    if item.Type == "Accent" then item.Object[item.Property] = CurrentTheme.Accent end
                    if item.Type == "Main" then item.Object[item.Property] = CurrentTheme.Main end
                end
            end
        end
    end

    -- // UI PRE-SETUP (v9.0 Redesign) //
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GalaxyV9"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false
    ScreenGui.DisplayOrder = 10000 
    
    -- SHADOW (Moved inside MainFrame for perfect sync)
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    MainFrame.Position = UDim2.new(0.5, -260, 0.5, -200) -- Centered
    MainFrame.Size = UDim2.new(0, 520, 0, 400)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)
    
    local Shadow = Instance.new("ImageLabel", MainFrame)
    Shadow.Name = "Shadow"
    Shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    Shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
    Shadow.Size = UDim2.new(1, 40, 1, 40) -- Slightly larger
    Shadow.Image = "rbxassetid://6015897843"
    Shadow.ImageTransparency = 0.4
    Shadow.BackgroundTransparency = 1
    Shadow.ZIndex = 0 -- Behind MainFrame (Default Frame is 1)
    
    -- MAIN STROKE
    local UIStroke = Instance.new("UIStroke", MainFrame); UIStroke.Thickness = 2; RegisterThemeObject(UIStroke, "Color", "Accent")

    local Sidebar = Instance.new("Frame", MainFrame)
    Sidebar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    Sidebar.Size = UDim2.new(0, 150, 1, 0)
    Sidebar.BorderSizePixel = 0
    Instance.new("UICorner", Sidebar).CornerRadius = UDim.new(0, 8)
    local SidebarStraightify = Instance.new("Frame", Sidebar); SidebarStraightify.BorderSizePixel=0; SidebarStraightify.BackgroundColor3=Sidebar.BackgroundColor3; SidebarStraightify.Size=UDim2.new(0,10,1,0); SidebarStraightify.Position=UDim2.new(1,-10,0,0) -- Square right side
    
    local SidebarTitle = Instance.new("TextLabel", Sidebar); SidebarTitle.Text = "GALAXY"; SidebarTitle.Font = Enum.Font.GothamBlack; SidebarTitle.TextSize = 32; SidebarTitle.Size = UDim2.new(1, 0, 0, 70); SidebarTitle.BackgroundTransparency = 1; RegisterThemeObject(SidebarTitle, "TextColor3", "Accent")
    
    -- Container
    local Container = Instance.new("Frame", MainFrame); Container.BackgroundTransparency = 1; Container.Position = UDim2.new(0, 160, 0, 10); Container.Size = UDim2.new(0, 350, 1, -20); Container.ClipsDescendants = true
    
    local HUD = Instance.new("Frame", ScreenGui); HUD.BackgroundTransparency = 1; HUD.Size = UDim2.new(1,0,1,0)
    local Watermark = Instance.new("TextLabel", HUD); Watermark.Position = UDim2.new(0,25,0,25); Watermark.Size = UDim2.new(0,200,0,30); Watermark.BackgroundTransparency = 1; Watermark.Text = "GALAXY V9.0"; Watermark.Font = Enum.Font.GothamBlack; Watermark.TextSize = 24; Watermark.TextXAlignment = Enum.TextXAlignment.Left; RegisterThemeObject(Watermark, "TextColor3", "Accent")

    local Tabs = {}
    local function CreateTab(name)
        local btn = Instance.new("TextButton", Sidebar)
        btn.Size = UDim2.new(1, -20, 0, 40)
        btn.Position = UDim2.new(0, 10, 0, 80 + (#Tabs * 45))
        btn.BackgroundTransparency = 1
        btn.Text = "  " .. name
        btn.Font = Enum.Font.GothamBold
        btn.TextColor3 = Color3.fromRGB(150, 150, 150)
        btn.TextSize = 14
        btn.TextXAlignment = Enum.TextXAlignment.Left
        btn.AutoButtonColor = false
        
        local frame = Instance.new("ScrollingFrame", Container)
        frame.BackgroundTransparency = 1
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.CanvasSize = UDim2.new(0,0,0,0)
        frame.ScrollBarThickness = 2
        frame.ScrollBarImageColor3 = Color3.fromRGB(80,80,80)
        frame.Visible = false
        
        local layout = Instance.new("UIListLayout", frame)
        layout.Padding = UDim.new(0, 8)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        
        -- Manual Canvas Size Calculation (Fixes Empty Tabs)
        layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            frame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 20)
        end)
        
        -- Animation
        btn.MouseEnter:Connect(function() if not frame.Visible then Tween(btn, {TextColor3 = Color3.fromRGB(200,200,200)}) end end)
        btn.MouseLeave:Connect(function() if not frame.Visible then Tween(btn, {TextColor3 = Color3.fromRGB(150,150,150)}) end end)
        
        table.insert(Tabs, {Btn = btn, Frame = frame})
        btn.MouseButton1Click:Connect(function()
            for _, t in pairs(Tabs) do t.Frame.Visible = false; Tween(t.Btn, {TextColor3 = Color3.fromRGB(150, 150, 150)}) end
            frame.Visible = true
            Tween(btn, {TextColor3 = Color3.new(1, 1, 1)})
        end)
        return frame
    end
    local TabCombat = CreateTab("Combat"); local TabVisuals = CreateTab("Visuals"); local TabMisc = CreateTab("Misc"); local TabSettings = CreateTab("Settings"); Tabs[1].Frame.Visible = true; Tabs[1].Btn.TextColor3 = Color3.new(1,1,1)

    -- // UI ELEMENTS (Animated) //
    local function AddToggle(parent, text, default, callback, id)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -5, 0, 42); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f).CornerRadius = UDim.new(0, 6)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.GothamBold; l.TextColor3 = Color3.new(1, 1, 1); l.BackgroundTransparency = 1; l.Size = UDim2.new(0.6, 0, 1, 0); l.Position = UDim2.new(0, 15, 0, 0); l.TextXAlignment = Enum.TextXAlignment.Left; l.TextSize=14
        
        -- Switch
        local switchBase = Instance.new("Frame", f); switchBase.Size = UDim2.new(0, 44, 0, 22); switchBase.Position = UDim2.new(1, -55, 0.5, -11); switchBase.BackgroundColor3 = Color3.fromRGB(50,50,55); Instance.new("UICorner", switchBase).CornerRadius = UDim.New(1,0)
        local switchCircle = Instance.new("Frame", switchBase); switchCircle.Size = UDim2.new(0, 18, 0, 18); switchCircle.Position = UDim2.new(0, 2, 0.5, -9); switchCircle.BackgroundColor3 = Color3.fromRGB(200,200,200); Instance.new("UICorner", switchCircle).CornerRadius = UDim.New(1,0)
        
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(1,0,1,0); btn.BackgroundTransparency = 1; btn.Text = ""
        
        local state = default
        local function Update()
            local targetColor = state and (config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent) or Color3.fromRGB(50,50,55)
            Tween(switchBase, {BackgroundColor3 = targetColor})
            Tween(switchCircle, {Position = state and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)})
        end
        
        local function Toggle(v)
            if v ~= nil then state = v else state = not state end
            Update()
            -- Play Sound
            local s = Instance.new("Sound", game:GetService("SoundService")); s.SoundId = state and "rbxassetid://4612375233" or "rbxassetid://4612377140"; s.Volume = 0.5; s:Play(); s.Ended:Connect(function() s:Destroy() end)
            task.spawn(function() callback(state) end)
        end
        Update()
        
        btn.MouseButton1Click:Connect(function() Toggle() end)

        -- DYNAMIC BINDING (Middle Click)
        if id then
            local function Bind(gui)
                gui.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton3 then
                        l.Text = text .. " ..."; l.TextColor3 = Color3.fromRGB(255, 200, 0)
                        local c; c = UserInputService.InputBegan:Connect(function(k)
                            if k.UserInputType == Enum.UserInputType.Keyboard then
                                config.binds[id] = k.KeyCode
                                l.Text = text .. " ["..k.KeyCode.Name.."]"
                                l.TextColor3 = Color3.new(1,1,1)
                                c:Disconnect()
                                if RefreshKeyList then RefreshKeyList() end
                            end
                        end)
                    end
                end)
            end
            Bind(btn)
            
            -- Safe Bind Check
            local c = UserInputService.InputBegan:Connect(function(io, g)
                if not g and config.binds and config.binds[id] and io.KeyCode == config.binds[id] then
                    Toggle()
                end
            end)
        end
    end
    
    local function AddSlider(parent, text, min, max, default, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -5, 0, 50); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f).CornerRadius = UDim.new(0, 6)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.GothamBold; l.TextColor3 = Color3.new(1,1,1); l.BackgroundTransparency = 1; l.Position = UDim2.new(0, 15, 0, 5); l.TextXAlignment = Enum.TextXAlignment.Left; l.TextSize = 14
        local vLabel = Instance.new("TextLabel", f); vLabel.Text = tostring(default); vLabel.Font = Enum.Font.GothamBold; vLabel.TextColor3 = Color3.new(1,1,1); vLabel.BackgroundTransparency = 1; vLabel.Position = UDim2.new(1, -40, 0, 5); vLabel.TextXAlignment = Enum.TextXAlignment.Right; vLabel.TextSize = 14
        
        local slideBar = Instance.new("Frame", f); slideBar.Size = UDim2.new(1, -30, 0, 6); slideBar.Position = UDim2.new(0, 15, 0, 32); slideBar.BackgroundColor3 = Color3.fromRGB(50,50,55); Instance.new("UICorner", slideBar).CornerRadius = UDim.new(1,0)
        local fill = Instance.new("Frame", slideBar); fill.Size = UDim2.new((default-min)/(max-min), 0, 1, 0); fill.BackgroundColor3 = (config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent); Instance.new("UICorner", fill).CornerRadius = UDim.new(1,0)
        
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(1,0,1,0); btn.BackgroundTransparency = 1; btn.Text = ""
        local dragging = false
        local function Update(input)
            local p = math.clamp((Mouse.X - slideBar.AbsolutePosition.X) / slideBar.AbsoluteSize.X, 0, 1)
            local value = math.floor(min + ((max - min) * p))
            Tween(fill, {Size = UDim2.new(p, 0, 1, 0)})
            vLabel.Text = tostring(value)
            callback(value)
        end
        
        slideBar.InputBegan:Connect(function(i) 
            if i.UserInputType == Enum.UserInputType.MouseButton1 then 
                dragging = true 
                Update(i) 
            end 
        end)
        
        Connect(UserInputService.InputEnded, function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
        Connect(UserInputService.InputChanged, function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Update(i) end end)
    end

    local function AddDropdown(parent, text, options, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -10, 0, 40); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f)
        local l = Instance.new("TextLabel", f); l.Text = text; l.Font = Enum.Font.Gotham; l.TextColor3 = Color3.new(1, 1, 1); l.BackgroundTransparency = 1; l.Size = UDim2.new(0.5, 0, 1, 0); l.Position = UDim2.new(0, 15, 0, 0); l.TextXAlignment = Enum.TextXAlignment.Left
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(0, 110, 0, 26); btn.Position = UDim2.new(1, -125, 0.17, 0); btn.Text = options[1]; btn.BackgroundColor3 = Color3.fromRGB(50, 50, 55); btn.TextColor3 = Color3.new(1, 1, 1); Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
        local idx = 1; btn.MouseButton1Click:Connect(function() idx = idx + 1; if idx > #options then idx = 1 end; btn.Text = options[idx]; callback(options[idx]) end)
    end

    local function AddBind(parent, text, id)
       AddToggle(parent, text, false, function(s) end, id) -- Uses MiddleClick logic inside AddToggle
    end

    -- // ULTIMATE UNIVERSAL SCANNER (HYBRID) //
    local TargetCache = {} -- Used for NPCs/Entities in "All" mode
    local PlayerCache = {} -- Used for Players (Instant update)

    -- Efficient Player Tracking
    local function AddPlayer(player)
        local function CharAdded(char)
            PlayerCache[player] = char
        end
        if player.Character then CharAdded(player.Character) end
        player.CharacterAdded:Connect(CharAdded)
    end
    
    -- Track new and existing players
    Players.PlayerAdded:Connect(AddPlayer)
    for _, p in pairs(Players:GetPlayers()) do 
        if p ~= LocalPlayer then AddPlayer(p) end 
    end
    Players.PlayerRemoving:Connect(function(p) PlayerCache[p] = nil end)

    -- Optimized NPC/Entity Scanner (Runs less frequently)
    local function ScanForNPCs()
        local list = {}
        if config.espMode == "All" then
            for _, v in pairs(workspace:GetDescendants()) do 
                if v:IsA("Humanoid") and v.Parent and v.Health > 0 then
                    local char = v.Parent
                    -- Exclude real players from this list to avoid double counting
                    if not Players:GetPlayerFromCharacter(char) and char ~= LocalPlayer.Character then
                        table.insert(list, char)
                    end
                end
            end
        end
        return list
    end

    task.spawn(function()
        while ScreenGui.Parent do
           TargetCache = ScanForNPCs()
           task.wait(1.5)
        end
    end)

    -- Unified Target Iterator
    local function GetTargets()
        local t = {}
        -- Always add players first (High Priority)
        if config.espMode == "Players" or config.espMode == "All" then
            for _, char in pairs(PlayerCache) do table.insert(t, char) end
        end
        -- Add NPCs if mode is All
        if config.espMode == "All" then
            for _, char in pairs(TargetCache) do table.insert(t, char) end
        end
        return t
    end

    -- // CORE COMBAT //
    local aimEnabled, triggerEnabled, triggerHolding = false, false, false
    local function getBestPart(char) return char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso") end
    local function isVisible(part) if not config.wallCheck then return true end; local r = workspace:Raycast(Camera.CFrame.Position, part.Position - Camera.CFrame.Position, RaycastParams.new()); return not r or r.Instance:IsDescendantOf(part.Parent) end

    RunService.RenderStepped:Connect(function()
        if config.bhop then
             if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") and LocalPlayer.Character.Humanoid.MoveDirection.Magnitude > 0 then
                 if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                     if LocalPlayer.Character.Humanoid.FloorMaterial ~= Enum.Material.Air then
                         LocalPlayer.Character.Humanoid.Jump = true
                     end
                 end
             end
        end

        if aimEnabled then
            local best, minDist = nil, config.fovSize
            local mousePos = Vector2.new(Mouse.X, Mouse.Y)
            -- Use Unified Target List
            local targets = GetTargets()
            
            for _, char in pairs(targets) do
                -- char is already the Character

                if char and char:FindFirstChildOfClass("Humanoid") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                    local part = getBestPart(char)
                    if part then
                        local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                        if onScreen then
                            local d = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                            if d < minDist and isVisible(part) then best = char; minDist = d end
                        end
                    end
                end
            end
            if best then
                local part = getBestPart(best); local pos = part.Position
                if config.usePrediction and best:FindFirstChild("HumanoidRootPart") then pos = pos + (best.HumanoidRootPart.Velocity * config.predictionFactor) end
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, pos)
            end
        end

        -- TRIGGERBOT 3.0 (RAPID FIRE)
        if triggerEnabled then
            local p = RaycastParams.new(); p.FilterDescendantsInstances = {LocalPlayer.Character, Camera, ScreenGui}; p.FilterType = Enum.RaycastFilterType.Exclude
            -- Reduced radius to 1.5 for "Crosshair" feeling (Precise but forgiving)
            local s, h = pcall(function() return workspace:Spherecast(Camera.CFrame.Position, 1.5, Camera.CFrame.LookVector * 1000, p) end)
            
            -- Simplified Check: Does it have a Humanoid?
            local isEnemy = false
            if s and h and h.Instance then
                local m = h.Instance:FindFirstAncestorOfClass("Model") or h.Instance.Parent
                if m and m:FindFirstChildOfClass("Humanoid") and m ~= LocalPlayer.Character then isEnemy = true end
            end
            
            if isEnemy then
                 -- RAPID FIRE LOGIC (Supports Semi-Auto & Auto)
                 if VirtualInputManager then
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
                 elseif mouse1click then
                    mouse1click()
                 elseif mouse1press then
                    mouse1press(); mouse1release()
                 end
            end
        end
    end)

    -- // VISUALS //
    local espEnabled = false
    -- // VISUALS ENGINE (v7.6 BEAMS & BOXES) //
    local function ClearVisuals(char)
        if char:FindFirstChild("G_Box") then char.G_Box:Destroy() end
        if char:FindFirstChild("G_Beam") then char.G_Beam:Destroy() end
        if char:FindFirstChild("G_Att") then char.G_Att:Destroy() end
    end

    Connect(RunService.Heartbeat, function()
        -- Ensure Local Attachment Exists
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            if not LocalPlayer.Character.HumanoidRootPart:FindFirstChild("G_Att_Local") then
                local a = Instance.new("Attachment", LocalPlayer.Character.HumanoidRootPart); a.Name = "G_Att_Local"
            end
        end

        local targets = GetTargets()
        for _, char in pairs(targets) do
            if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
                local hrp = char.HumanoidRootPart
                
                -- [[ BOX ESP (Styled) ]]
                if config.boxEsp then
                    if not char:FindFirstChild("G_Box") then
                        local bb = Instance.new("BillboardGui", char); bb.Name = "G_Box"; bb.Size = UDim2.new(4,0,5.5,0); bb.AlwaysOnTop = true; bb.StudsOffset = Vector3.new(0,0,0)
                        local f = Instance.new("Frame", bb); f.Size = UDim2.new(1,0,1,0); f.BackgroundTransparency = 1
                        -- Black Outline (Background)
                        local s1 = Instance.new("UIStroke", f); s1.Name = "Outline"; s1.Thickness = 2.5; s1.Color = Color3.new(0,0,0); s1.Transparency = 0
                        -- Colored Inline (Foreground)
                        local s2 = Instance.new("UIStroke", f); s2.Name = "Inline"; s2.Thickness = 1; s2.Color = rainbowColor; s2.Transparency = 0
                    end
                    local box = char.G_Box.Frame
                    box.Inline.Color = config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent
                else
                    if char:FindFirstChild("G_Box") then char.G_Box:Destroy() end
                end

                -- [[ TRACERS (Beams) ]]
                if config.tracers and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart:FindFirstChild("G_Att_Local") then
                    if not char:FindFirstChild("G_Beam") then
                        -- Create Attachment on Target
                        local att = Instance.new("Attachment", hrp); att.Name = "G_Att"
                        -- Create Beam
                        local b = Instance.new("Beam", char); b.Name = "G_Beam"
                        b.Attachment0 = LocalPlayer.Character.HumanoidRootPart.G_Att_Local
                        b.Attachment1 = att
                        b.FaceCamera = true; b.Width0 = 0.2; b.Width1 = 0.2
                        b.Color = ColorSequence.new(rainbowColor)
                    end
                    local beam = char.G_Beam
                    beam.Color = ColorSequence.new(config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent)
                 else
                    ClearVisuals(char) -- Cleanup logic handled here mostly
                 end
            else
                ClearVisuals(char)
            end
        end
        
        -- Cleanup Orphans
        for _, c in pairs(ScreenGui:GetChildren()) do if c.Name:sub(1,2) == "T_" then c:Destroy() end end -- Remove old 2D tracers
    end)
    
    -- PHYSICS LOOP (Speed, Jump, NoClip, BHop)
    Connect(RunService.RenderStepped, function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
             local char = LocalPlayer.Character
             local hum = char.Humanoid
             
             -- Speed BHop
             if config.bhop and hum.MoveDirection.Magnitude > 0 then
                 if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                     if hum.FloorMaterial ~= Enum.Material.Air then
                         hum.Jump = true
                         -- Speed Boost
                         local root = char:FindFirstChild("HumanoidRootPart")
                         if root then
                             root.Velocity = root.Velocity + (hum.MoveDirection * 5) -- Boost
                         end
                     end
                 end
             end
        end
    end)

    Connect(RunService.Stepped, function()
        if LocalPlayer.Character then
             local char = LocalPlayer.Character
             if char:FindFirstChild("Humanoid") then
                if config.walkSpeed > 16 then char.Humanoid.WalkSpeed = config.walkSpeed end
                if config.jumpPower > 50 then char.Humanoid.JumpPower = config.jumpPower end
             end
             if config.noclip then
                for _, v in pairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
             end
             if config.antiAim then
                 local root = char:FindFirstChild("HumanoidRootPart")
                 if root then
                     root.CFrame = root.CFrame * CFrame.Angles(0, math.rad(100), 0) * CFrame.Angles(math.rad(math.random(-20,20)), 0, 0)
                 end
             end
             if config.infAmmo then
                 for _, v in pairs(char:GetDescendants()) do
                     if (v:IsA("IntValue") or v:IsA("NumberValue")) then
                         local n = v.Name:lower()
                         if n == "ammo" or n == "clip" or n == "mag" or n == "stored" or n == "reserve" then v.Value = 999 end
                     end
                 end
             end
        end
    end)

    -- // BINDING // 
    AddToggle(TabCombat, "Aimbot", false, function(s) aimEnabled = s end, "aim")
    AddToggle(TabCombat, "TriggerBot", false, function(s) triggerEnabled = s end, "trig")
    AddToggle(TabCombat, "Knife Aura", false, function(s) config.knifeBot = s end, "knife")
    AddSlider(TabCombat, "Knife Range", 5, 30, 15, function(v) config.knifeRange = v end)
    
    AddToggle(TabCombat, "No Recoil", false, function(s) config.noRecoil = s end) -- Defuse Division / Universal

    AddToggle(TabCombat, "Inf Ammo (Univ)", false, function(s) config.infAmmo = s end, "ammo")
    AddToggle(TabCombat, "Wall Check", true, function(s) config.wallCheck = s end, "wall")
    
    AddToggle(TabVisuals, "ESP", false, function(s) espEnabled = s end, "esp")
    AddToggle(TabVisuals, "Show FOV", true, function(s) config.showFov = s end, "fov")
    AddToggle(TabVisuals, "Tracers (Beam)", false, function(s) config.tracers = s end, "trace")
    AddToggle(TabVisuals, "Box ESP (Style)", false, function(s) config.boxEsp = s end, "box")
    AddDropdown(TabVisuals, "Scan Mode", {"All", "Players"}, function(v) config.espMode = v end)

    AddToggle(TabMisc, "NoClip", false, function(s) config.noclip = s end, "noclip")
    AddToggle(TabMisc, "Rage Anti-Aim", false, function(s) config.antiAim = s end, "aa") -- SPINBOT
    AddToggle(TabMisc, "Speed BHop", false, function(s) config.bhop = s end, "bhop")
    AddSlider(TabMisc, "Speed", 16, 200, 16, function(v) config.walkSpeed = v end)
    
    -- // KEYBIND HUD UI //
    local KeyList = Instance.new("Frame", ScreenGui); KeyList.Position = UDim2.new(0, 20, 0.4, 0); KeyList.Size = UDim2.new(0, 180, 0, 250); KeyList.BackgroundColor3 = Color3.fromRGB(20,20,25); KeyList.BackgroundTransparency = 0.2; KeyList.Active = true; KeyList.Draggable = true
    Instance.new("UICorner", KeyList).CornerRadius = UDim.new(0, 8)
    local KeyTitle = Instance.new("TextLabel", KeyList); KeyTitle.Name = "Title"; KeyTitle.Text = "  Active Keybinds"; KeyTitle.Font = Enum.Font.GothamBlack; KeyTitle.TextColor3 = Color3.new(1,1,1); KeyTitle.Size = UDim2.new(1,0,0,30); KeyTitle.BackgroundTransparency = 1; KeyTitle.TextXAlignment = Enum.TextXAlignment.Left; KeyTitle.TextSize=14
    local KeyLayout = Instance.new("UIListLayout", KeyList); KeyLayout.SortOrder = Enum.SortOrder.LayoutOrder; KeyLayout.Padding = UDim.new(0,0); KeyLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    -- Padding for list
    local KeyPad = Instance.new("UIPadding", KeyList); KeyPad.PaddingTop = UDim.new(0, 35); KeyPad.PaddingLeft = UDim.new(0,10)
    KeyList.Visible = config.keybindList
    
    -- // SEARCH UI // (Skipped for brevity/redundancy in this diff, assuming untouched logic below)
    -- (Previous code was here, ensuring variables are local)

    -- // KEYBIND HUD REFRESHER //
    -- Forward Declared at top of LoadGalaxy scope ideally, but we assign here.
    -- RefreshKeyList was defined as 'local function', meaning earlier closures (AddBind) might miss it if not careful.
    -- We will make it global to this scope or ensure it's captured. 
    -- Better: Assign to a pre-defined local if possible, or just rely on 'RefreshKeyList' being visible here.
    -- For now, we keep it here but ensure the initial call is safe.
    
    local function AddKeybind_Dummy() end -- Placeholder
    
    RefreshKeyList = function()
        if not KeyList then return end
        -- Clear old labels (KEEP TITLE)
        for _, c in pairs(KeyList:GetChildren()) do
            if c:IsA("TextLabel") and c.Name ~= "Title" then c:Destroy() end
        end
        
        -- Helper to add entry
        local function AddListEntry(name, key)
            if not key or typeof(key) ~= "EnumItem" then return end
            local t = Instance.new("TextLabel", KeyList)
            t.Name = name
            t.Size = UDim2.new(1, -10, 0, 24)
            t.BackgroundTransparency = 1
            t.Text = name .. " [" .. key.Name .. "]"
            t.Font = Enum.Font.GothamBold
            t.TextSize = 16
            t.TextColor3 = config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent
            t.TextXAlignment = Enum.TextXAlignment.Left
        end
        
        -- Static Binds checks
        if config.menuKey then AddListEntry("Menu", config.menuKey) end
        if config.aimKey then AddListEntry("Aimbot", config.aimKey) end
        if config.triggerKey then AddListEntry("Trigger", config.triggerKey) end
        
        -- Dynamic Binds
        if config.binds then
            for id, k in pairs(config.binds) do
                local names = {
                    esp="ESP", fly="Fly", noclip="NoClip", tp="3rd Person", 
                    aa="Anti-Aim", trace="Tracers", bhop="BunnyHop", knife="KnifeBot"
                }
                AddListEntry(names[id] or id, k)
            end
        end
    end
    
    -- Expose to shared scope if needed (Hack for AddBind to see it if it wasn't valid)
    -- Actually, since AddBind calls it inside a callback, it resolves the upvalue at RUNTIME. 
    -- As long as RefreshKeyList is defined in the same scope 'LoadGalaxy' before the callback fires, it works.
    -- Initial Call:
    task.spawn(function() pcall(RefreshKeyList) end)
    
    -- Hook into Theme Update
    game:GetService("RunService").RenderStepped:Connect(function()
        if KeyList.Visible and config.theme == "Rainbow" then
             for _, c in pairs(KeyList:GetChildren()) do
                 if c:IsA("TextLabel") then c.TextColor3 = rainbowColor end
             end
        end
    end)

    AddToggle(TabSettings, "Show Keybind List", true, function(s) KeyList.Visible = s end)
    AddSlider(TabMisc, "Jump", 50, 300, 50, function(v) config.jumpPower = v end)
    
    -- CUSTOM THIRD PERSON (ShiftLock Style)
    local CamRot = Vector2.new(0,0)
    AddToggle(TabMisc, "Third Person", false, function(s) 
        config.thirdPerson = s 
        if s then
            RunService:BindToRenderStep("GalaxyTP", Enum.RenderPriority.Camera.Value + 1, function()
                -- v8.2: Menu Priority
                if MainFrame.Visible then
                    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
                    return
                end
                
                UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
                local mouseDelta = UserInputService:GetMouseDelta()
                CamRot = CamRot - mouseDelta * 0.005 -- Sens
                -- Clamp Pitch
                CamRot = Vector2.new(CamRot.X, math.clamp(CamRot.Y, math.rad(-80), math.rad(80)))
                
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") then
                   local head = LocalPlayer.Character.Head
                   -- Calculate CFrame
                   local rotCFrame = CFrame.Angles(0, CamRot.X, 0) * CFrame.Angles(CamRot.Y, 0, 0)
                   local finalCFrame = CFrame.new(head.Position) * rotCFrame * CFrame.new(2, 2, config.thirdPersonDist) -- Offset
                   
                   -- Raycast for collision (Auto-Zoom logic) can be added here, but user wants raw control.
                   Camera.CFrame = finalCFrame
                   Camera.Focus = CFrame.new(head.Position)
                end
            end)
        else
            RunService:UnbindFromRenderStep("GalaxyTP")
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
            LocalPlayer.CameraMode = Enum.CameraMode.Custom -- Reset
        end
    end, "tp")
    AddSlider(TabMisc, "TP Dist", 10, 50, 20, function(v) config.thirdPersonDist = v end)
    
    AddToggle(TabMisc, "Fly Mode [F]", false, function(s)
        local root = LocalPlayer.Character.HumanoidRootPart
        if s then
            local bg = Instance.new("BodyGyro", root); bg.maxTorque = Vector3.new(inf,inf,inf); bg.Name = "FlyG"
            local bv = Instance.new("BodyVelocity", root); bv.maxForce = Vector3.new(inf,inf,inf); bv.Name = "FlyV"
            LocalPlayer.Character.Humanoid.PlatformStand = true
            task.spawn(function() while s and root.Parent do RunService.RenderStepped:Wait(); local d = Vector3.new(); if UserInputService:IsKeyDown(Enum.KeyCode.W) then d=d+Camera.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.S) then d=d-Camera.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.A) then d=d-Camera.CFrame.RightVector end; if UserInputService:IsKeyDown(Enum.KeyCode.D) then d=d+Camera.CFrame.RightVector end; bv.Velocity = d * 65; bg.CFrame = Camera.CFrame end end)
        else
            LocalPlayer.Character.Humanoid.PlatformStand = false; if root:FindFirstChild("FlyG") then root.FlyG:Destroy() end; if root:FindFirstChild("FlyV") then root.FlyV:Destroy() end
        end
    end)
    
    -- TP handled by BindToRenderStep now

    AddDropdown(TabSettings, "Theme", {"Rainbow", "Purple", "Blue", "Red"}, function(v) UpdateThemeColors(v) end)
    AddKeybind(TabSettings, "Menu Key", config.menuKey, "menuKey")
    AddKeybind(TabSettings, "Aimbot Bind", config.aimKey, "aimKey")
    AddKeybind(TabSettings, "Trigger Bind", config.triggerKey, "triggerKey")
    
    -- Explicit Function Binds (Refresh HUD on change)
    AddBind(TabSettings, "ESP Toggle", "esp")
    AddBind(TabSettings, "Fly Toggle", "fly")
    AddBind(TabSettings, "NoClip Toggle", "noclip")
    AddBind(TabSettings, "Third Person Toggle", "tp")
    AddBind(TabSettings, "Anti-Aim Toggle", "aa")
    AddBind(TabSettings, "Tracers Toggle", "trace")
    AddBind(TabSettings, "Speed BHop Toggle", "bhop")
    AddBind(TabSettings, "KnifeBot Toggle", "knife")
    
    
    local function AddButton(parent, text, callback)
        local f = Instance.new("Frame", parent); f.Size = UDim2.new(1, -5, 0, 42); f.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", f).CornerRadius = UDim.new(0, 6)
        local btn = Instance.new("TextButton", f); btn.Size = UDim2.new(1, 0, 1, 0); btn.BackgroundTransparency = 1; btn.Text = text; btn.Font = Enum.Font.GothamBold; btn.TextColor3 = Color3.new(1, 1, 1); btn.TextSize = 14
        
        btn.MouseEnter:Connect(function() Tween(f, {BackgroundColor3 = Color3.fromRGB(45, 45, 50)}) end)
        btn.MouseLeave:Connect(function() Tween(f, {BackgroundColor3 = Color3.fromRGB(35, 35, 40)}) end)
        btn.MouseButton1Click:Connect(callback)
    end
    
    -- // DEEP SERIALIZATION (Fixes Config Saving) //
    local function Serialize(tbl)
        local res = {}
        for k, v in pairs(tbl) do
            if type(v) == "table" then
                res[k] = Serialize(v)
            elseif typeof(v) == "EnumItem" then
                res[k] = {__ENUM = tostring(v)}
            else
                res[k] = v
            end
        end
        return res
    end
    
    local function Deserialize(tbl)
        local res = {}
        for k, v in pairs(tbl) do
            if type(v) == "table" then
                if v.__ENUM then
                     -- Parse Enum string "Enum.KeyCode.E"
                     local parts = v.__ENUM:split(".") -- {"Enum", "KeyCode", "E"}
                     res[k] = Enum[parts[2]][parts[3]]
                else
                     res[k] = Deserialize(v)
                end
            else
                res[k] = v
            end
        end
        return res
    end

    AddButton(TabSettings, "Save Config", function()
        local data = Serialize(config)
        writefile("galaxy_cfg.json", HttpService:JSONEncode(data))
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Saved Successfully", Duration = 2})
    end)
    
    AddButton(TabSettings, "Load Config", function()
        if isfile("galaxy_cfg.json") then
            local data = HttpService:JSONDecode(readfile("galaxy_cfg.json"))
            local loaded = Deserialize(data)
            for k, v in pairs(loaded) do
                config[k] = v
            end
            RefreshKeyList() -- Update UI
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Galaxy", Text = "Config Loaded!", Duration = 3})
        end
    end)

    AddButton(TabSettings, "UNLOAD CHEAT", function()
        for _, c in pairs(Connections) do c:Disconnect() end
        RunService:UnbindFromRenderStep("GalaxyTP") 
        ScreenGui:Destroy()
        -- Reset Fly
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.PlatformStand = false
        end
        game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY", Text = "Unloaded Successfully", Duration = 3})
    end)

    Connect(UserInputService.InputBegan, function(i, g) if not g and i.KeyCode == config.menuKey then MainFrame.Visible = not MainFrame.Visible end end)
    
    local Circle = Instance.new("Frame", ScreenGui); Circle.BackgroundTransparency = 1; Circle.BorderSizePixel = 0
    local CircleStroke = Instance.new("UIStroke", Circle); CircleStroke.Thickness = 2
    local CircleCorner = Instance.new("UICorner", Circle); CircleCorner.CornerRadius = UDim.new(1,0)
    
    Connect(RunService.RenderStepped, function() 
        Circle.Visible = config.showFov and aimEnabled
        Circle.Position = UDim2.new(0, Mouse.X - config.fovSize, 0, Mouse.Y - config.fovSize)
        Circle.Size = UDim2.new(0, config.fovSize*2, 0, config.fovSize*2)
        local c = config.theme == "Rainbow" and rainbowColor or CurrentTheme.Accent
        CircleStroke.Color = c
        
        -- v8.2: GENERAL MOUSE UNLOCK & ICON VISIBILITY
        if MainFrame.Visible then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
            UserInputService.MouseIconEnabled = true
        end
    end)
    
    game:GetService("StarterGui"):SetCore("SendNotification", {Title = "GALAXY V8.2", Text = "All-Seeing Eye Loaded", Duration = 5})
end

-- // PERSISTENT AUTH //
if isfile("galaxy.auth") and readfile("galaxy.auth") == "2026" then
    KeySystemGui:Destroy()
    LoadGalaxy()
else
    KeyBtn.MouseButton1Click:Connect(function() 
        if KeyBox.Text == "2026" then 
            writefile("galaxy.auth", "2026") -- Save Token
            KeySystemGui:Destroy() 
            LoadGalaxy() 
        end 
    end)
end
