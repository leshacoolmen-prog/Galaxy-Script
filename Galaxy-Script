local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- // CONFIGURATION //
local config = {
    -- Keys
    menuKey = Enum.KeyCode.Insert,
    aaKey = Enum.KeyCode.Z,
    flyKey = Enum.KeyCode.X,
    carpetKey = Enum.KeyCode.C,
    noclipKey = Enum.KeyCode.N,
    aimKey = Enum.KeyCode.E,
    espKey = Enum.KeyCode.R,
    triggerKey = Enum.KeyCode.T,
    
    -- Values
    fovSize = 250,
    silentAim = false,
    showFov = true,
    thirdPerson = true,
    wallCheck = true, -- Can be toggled for "Wallshot"
    teamCheck = false,
    usePrediction = true,
    predictionFactor = 0.065,
    espMode = "Players", -- "Players" or "All"
    
    -- Visuals
    theme = "Purple"
}

-- // THEME ENGINE //
local Themes = {
    Purple = {Main = Color3.fromRGB(20, 20, 25), Accent = Color3.fromRGB(170, 0, 255), Text = Color3.fromRGB(255, 255, 255)},
    Blue = {Main = Color3.fromRGB(20, 25, 30), Accent = Color3.fromRGB(0, 150, 255), Text = Color3.fromRGB(255, 255, 255)},
    Orange = {Main = Color3.fromRGB(25, 20, 15), Accent = Color3.fromRGB(255, 100, 0), Text = Color3.fromRGB(255, 255, 255)},
    Red = {Main = Color3.fromRGB(25, 15, 15), Accent = Color3.fromRGB(255, 40, 40), Text = Color3.fromRGB(255, 255, 255)}
}
local CurrentTheme = Themes.Purple
local ThemeObjects = {} 

local function RegisterThemeObject(obj, prop, type)
    table.insert(ThemeObjects, {Object = obj, Property = prop, Type = type})
    if type == "Accent" then obj[prop] = CurrentTheme.Accent
    elseif type == "Main" then obj[prop] = CurrentTheme.Main end
end

local function UpdateTheme(themeName)
    if Themes[themeName] then
        CurrentTheme = Themes[themeName]
        config.theme = themeName
        for _, item in pairs(ThemeObjects) do
             if item.Type == "Accent" then item.Object[item.Property] = CurrentTheme.Accent end
             if item.Type == "Main" then item.Object[item.Property] = CurrentTheme.Main end
        end
    end
end

-- // UI SETUP //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GalaxyV16"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

-- HUD ELEMENTS
local HUD = Instance.new("Frame", ScreenGui)
HUD.Name = "HUD"; HUD.BackgroundTransparency=1; HUD.Size=UDim2.new(1,0,1,0)

local Watermark = Instance.new("TextLabel", HUD)
Watermark.Position = UDim2.new(0, 20, 0, 20); Watermark.Size = UDim2.new(0, 200, 0, 30); Watermark.BackgroundTransparency=1
Watermark.Text = "GALAXY V16 EXPERIMENTAL"; Watermark.Font=Enum.Font.GothamBlack; Watermark.TextSize=24; Watermark.TextXAlignment=Enum.TextXAlignment.Left
RegisterThemeObject(Watermark, "TextColor3", "Accent")
local Gradient = Instance.new("UIGradient", Watermark)
Gradient.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.new(1,1,1)), ColorSequenceKeypoint.new(1, Color3.new(0.5,0.5,0.5))}

local ArrayList = Instance.new("Frame", HUD)
ArrayList.Position=UDim2.new(0,20,0,50); ArrayList.Size=UDim2.new(0,200,0,500); ArrayList.BackgroundTransparency=1
local ArrayLayout = Instance.new("UIListLayout", ArrayList); ArrayLayout.SortOrder=Enum.SortOrder.LayoutOrder; ArrayLayout.Padding=UDim.new(0,2)

local KeybindDisplay = Instance.new("Frame", HUD)
KeybindDisplay.Position=UDim2.new(0,20,0.4,0); KeybindDisplay.Size=UDim2.new(0,200,0,300); KeybindDisplay.BackgroundTransparency=1
local KeybindTitle = Instance.new("TextLabel", KeybindDisplay)
KeybindTitle.Size=UDim2.new(1,0,0,25); KeybindTitle.BackgroundTransparency=1; KeybindTitle.Text="[ Keybinds ]"; KeybindTitle.TextColor3=Color3.fromRGB(200,200,200); KeybindTitle.Font=Enum.Font.GothamBold; KeybindTitle.TextSize=16; KeybindTitle.TextXAlignment=Enum.TextXAlignment.Left
local KeybindList = Instance.new("Frame", KeybindDisplay)
KeybindList.Position=UDim2.new(0,0,0,30); KeybindList.Size=UDim2.new(1,0,1,-30); KeybindList.BackgroundTransparency=1
local BindLayout = Instance.new("UIListLayout", KeybindList); BindLayout.SortOrder=Enum.SortOrder.LayoutOrder

-- HUD Helpers
local ActiveFeatures = {}
local function UpdateHUD(feature, state)
    if state then
        if not ActiveFeatures[feature] then
            local l = Instance.new("TextLabel", ArrayList)
            l.Name=feature; l.BackgroundTransparency=1; l.Size=UDim2.new(1,0,0,20); l.Font=Enum.Font.GothamBold; l.Text=string.upper(feature); l.TextStrokeTransparency=0.5; l.TextSize=16; l.TextXAlignment=Enum.TextXAlignment.Left
            RegisterThemeObject(l, "TextColor3", "Accent")
            ActiveFeatures[feature] = l
        end
    else
        if ActiveFeatures[feature] then ActiveFeatures[feature]:Destroy(); ActiveFeatures[feature] = nil end
    end
end

local BindLabels = {}
local function RefreshKeybinds()
    for _, v in pairs(BindLabels) do v:Destroy() end; BindLabels = {}
    local binds = {{Name="Menu",Key=config.menuKey}, {Name="Aimbot",Key=config.aimKey}, {Name="Trigger",Key=config.triggerKey}, {Name="ESP",Key=config.espKey}, {Name="AA",Key=config.aaKey}, {Name="Fly",Key=config.flyKey}, {Name="Noclip",Key=config.noclipKey}}
    for _, b in pairs(binds) do
        local l = Instance.new("TextLabel", KeybindList); l.Size=UDim2.new(1,0,0,20); l.BackgroundTransparency=1; l.Text="["..b.Key.Name.."]  "..b.Name; l.TextColor3=Color3.fromRGB(180,180,180); l.Font=Enum.Font.Gotham; l.TextSize=14; l.TextXAlignment=Enum.TextXAlignment.Left; table.insert(BindLabels, l)
    end
end

-- MAIN MENU
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.BackgroundColor3=CurrentTheme.Main; MainFrame.Position=UDim2.new(0.35,0,0.35,0); MainFrame.Size=UDim2.new(0,500,0,380); MainFrame.Active=true; MainFrame.Draggable=true
RegisterThemeObject(MainFrame, "BackgroundColor3", "Main")
local UIStroke = Instance.new("UIStroke", MainFrame); UIStroke.Thickness=2; RegisterThemeObject(UIStroke, "Color", "Accent")

local Sidebar = Instance.new("Frame", MainFrame); Sidebar.BackgroundColor3=Color3.fromRGB(30,30,35); Sidebar.Size=UDim2.new(0,130,1,0); Sidebar.BorderSizePixel=0
local Title = Instance.new("TextLabel", Sidebar); Title.Text="GALAXY"; Title.Font=Enum.Font.GothamBlack; Title.TextSize=26; Title.Size=UDim2.new(1,0,0,50); Title.BackgroundTransparency=1; RegisterThemeObject(Title, "TextColor3", "Accent")
local Container = Instance.new("Frame", MainFrame); Container.BackgroundTransparency=1; Container.Position=UDim2.new(0,140,0,10); Container.Size=UDim2.new(0,340,1,-20)

local Tabs = {}
local function CreateTab(name)
    local btn = Instance.new("TextButton", Sidebar); btn.Size=UDim2.new(1,0,0,40); btn.Position=UDim2.new(0,0,0,50+(#Tabs*40)); btn.BackgroundTransparency=1; btn.Text=name; btn.Font=Enum.Font.GothamBold; btn.TextColor3=Color3.fromRGB(150,150,150); btn.TextSize=14
    local frame = Instance.new("ScrollingFrame", Container); frame.BackgroundTransparency=1; frame.Size=UDim2.new(1,0,1,0); frame.ScrollBarThickness=2; frame.Visible=false
    local layout = Instance.new("UIListLayout", frame); layout.Padding=UDim.new(0,5); layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() frame.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end)
    table.insert(Tabs, {Btn=btn, Frame=frame})
    btn.MouseButton1Click:Connect(function() for _,t in pairs(Tabs) do t.Frame.Visible=false; t.Btn.TextColor3=Color3.fromRGB(150,150,150) end; frame.Visible=true; btn.TextColor3=CurrentTheme.Accent end)
    return frame
end
local TabCombat = CreateTab("Combat"); local TabVisuals = CreateTab("Visuals"); local TabMisc = CreateTab("Misc"); local TabSettings = CreateTab("Settings")
Tabs[1].Frame.Visible=true; Tabs[1].Btn.TextColor3=CurrentTheme.Accent

-- WIDGETS
local function AddToggle(parent, text, default, callback)
    local f = Instance.new("Frame", parent); f.Size=UDim2.new(1,0,0,35); f.BackgroundColor3=Color3.fromRGB(40,40,45); Instance.new("UICorner", f).CornerRadius=UDim.new(0,6)
    local l = Instance.new("TextLabel", f); l.Text=text; l.Font=Enum.Font.GothamSemibold; l.TextColor3=Color3.new(1,1,1); l.BackgroundTransparency=1; l.Size=UDim2.new(0.7,0,1,0); l.Position=UDim2.new(0,10,0,0); l.TextXAlignment=Enum.TextXAlignment.Left
    local btn = Instance.new("TextButton", f); btn.Size=UDim2.new(0,40,0,20); btn.Position=UDim2.new(0.8,0,0.2,0); btn.Text=""; btn.BackgroundColor3 = default and CurrentTheme.Accent or Color3.fromRGB(60,60,60); Instance.new("UICorner", btn).CornerRadius=UDim.new(1,0)
    local state = default
    btn.MouseButton1Click:Connect(function() state=not state; btn.BackgroundColor3 = state and CurrentTheme.Accent or Color3.fromRGB(60,60,60); callback(state); UpdateHUD(text, state) end)
end
local function AddDropdown(parent, text, options, callback)
    local f = Instance.new("Frame", parent); f.Size=UDim2.new(1,0,0,35); f.BackgroundColor3=Color3.fromRGB(40,40,45); Instance.new("UICorner", f).CornerRadius=UDim.new(0,6)
    local l = Instance.new("TextLabel", f); l.Text=text; l.Font=Enum.Font.GothamSemibold; l.TextColor3=Color3.new(1,1,1); l.BackgroundTransparency=1; l.Size=UDim2.new(0.5,0,1,0); l.Position=UDim2.new(0,10,0,0); l.TextXAlignment=Enum.TextXAlignment.Left
    local btn = Instance.new("TextButton", f); btn.Size=UDim2.new(0.4,0,0.7,0); btn.Position=UDim2.new(0.55,0,0.15,0); btn.Text=options[1]; btn.BackgroundColor3=Color3.fromRGB(50,50,55); btn.TextColor3=Color3.new(1,1,1); Instance.new("UICorner", btn).CornerRadius=UDim.new(0,4)
    local idx=1; btn.MouseButton1Click:Connect(function() idx=idx+1; if idx>#options then idx=1 end; btn.Text=options[idx]; callback(options[idx]) end)
end
local function AddKeybind(parent, text, defaultKey, configKey)
    local f = Instance.new("Frame", parent); f.Size=UDim2.new(1,0,0,35); f.BackgroundColor3=Color3.fromRGB(40,40,45); Instance.new("UICorner", f).CornerRadius=UDim.new(0,6)
    local l = Instance.new("TextLabel", f); l.Text=text; l.Font=Enum.Font.GothamSemibold; l.TextColor3=Color3.fromRGB(200,200,200); l.BackgroundTransparency=1; l.Size=UDim2.new(0.6,0,1,0); l.Position=UDim2.new(0,10,0,0); l.TextXAlignment=Enum.TextXAlignment.Left
    local b = Instance.new("TextButton", f); b.Size=UDim2.new(0.3,0,0.7,0); b.Position=UDim2.new(0.65,0,0.15,0); b.Text=defaultKey.Name; b.BackgroundColor3=Color3.fromRGB(50,50,55); b.TextColor3=Color3.new(1,1,1); Instance.new("UICorner", b).CornerRadius=UDim.new(0,4)
    local lis=false; b.MouseButton1Click:Connect(function() lis=true; b.Text="..." end); UserInputService.InputBegan:Connect(function(i) if lis and i.UserInputType==Enum.UserInputType.Keyboard then config[configKey]=i.KeyCode; b.Text=i.KeyCode.Name; lis=false; RefreshKeybinds() end end)
end

-- LOGIC
local aa, fly, carpet, noclip, aim, esp, trigger = false, false, false, false, false, false, false
local connAA, connFly, connCarpet, connNoclip, connAim, connTrigger, connEsp

local function isEnemy(plr)
    if not config.teamCheck then return true end
    if not plr.Team then return true end
    return plr.Team ~= LocalPlayer.Team
end

local function getPart(char)
    -- Added UpperTorso for R15 support
    return char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso") or char:FindFirstChild("Torso")
end

local function isVisible(targetPart)
    if not config.wallCheck then return true end
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, Camera, ScreenGui}
    params.FilterType = Enum.RaycastFilterType.Exclude
    -- Safe calculation
    if not targetPart then return false end
    local res = workspace:Raycast(Camera.CFrame.Position, targetPart.Position - Camera.CFrame.Position, params)
    if res and res.Instance:IsDescendantOf(targetPart.Parent) then return true end
    if res and (res.Instance.Transparency > 0.3 or not res.Instance.CanCollide) then return true end
    return res == nil
end

-- TRIGGERBOT HOLD-MODE
local triggerHolding = false
local function pressMouse(state)
    if state then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        triggerHolding = true
    else
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        triggerHolding = false
    end
end

local function startTrigger()
    if connTrigger then connTrigger:Disconnect() end
    connTrigger = RunService.RenderStepped:Connect(function() 
        if not trigger then if triggerHolding then pressMouse(false) end return end
        
        -- SphereCast
        local params = RaycastParams.new()
        params.FilterDescendantsInstances = {LocalPlayer.Character, Camera, ScreenGui}
        params.FilterType = Enum.RaycastFilterType.Exclude
        local dir = Camera.CFrame.LookVector * 1000
        
        local targetFound = false
        local success, hit = pcall(function() return workspace:Spherecast(Camera.CFrame.Position, 4, dir, params) end)
        
        if success and hit and hit.Instance then
            local char = hit.Instance.Parent
            -- Check parent's parent if hit accessory
            if not char:FindFirstChild("Humanoid") and char.Parent:FindFirstChild("Humanoid") then char = char.Parent end
            
            if char:FindFirstChild("Humanoid") then
                local p = Players:GetPlayerFromCharacter(char)
                if p then
                     if p ~= LocalPlayer and isEnemy(p) and char.Humanoid.Health > 0 then targetFound = true end
                else
                     -- Universal Check (For NPCs/Ghouls/Etc)
                     if char.Humanoid.Health > 0 then targetFound = true end
                end
            end
        end
        
        if targetFound then
            if not triggerHolding then pressMouse(true) end
        else
            if triggerHolding then pressMouse(false) end
        end
    end)
end

-- UI ACTIONS
AddToggle(TabCombat, "Aimbot", false, function(s) aim=s; UpdateHUD("Aimbot", s); if not s and connAim then connAim:Disconnect() elseif s then
    connAim = RunService.RenderStepped:Connect(function()
        if config.silentAim and not UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then return end
        local closest, dist = nil, config.fovSize
        local m = Vector2.new(Mouse.X, Mouse.Y)
        local targets = {}
        if config.espMode == "Players" then
            for _,p in pairs(Players:GetPlayers()) do table.insert(targets, p) end
        else
            for _,v in pairs(workspace:GetChildren()) do if v:IsA("Model") and v:FindFirstChild("Humanoid") and v ~= LocalPlayer.Character then table.insert(targets, v) end end
        end
        
        for _, t in pairs(targets) do
            local char = t.Character or t
            if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                 local isFriendly = false
                 if t:IsA("Player") then 
                    if t == LocalPlayer or not isEnemy(t) then isFriendly = true end
                 end
                 
                 if not isFriendly then
                     local part = getPart(char)
                     if part then
                         local v, vis = Camera:WorldToViewportPoint(part.Position)
                         if vis and (Vector2.new(v.X, v.Y)-m).Magnitude < dist then
                             if not config.wallCheck or isVisible(part) then
                                 closest = char; dist = (Vector2.new(v.X, v.Y)-m).Magnitude
                             end
                         end
                     end
                 end
            end
        end
        
        if closest then
             local part = getPart(closest)
             if part then
                 local vel = Vector3.new(0,0,0)
                 if closest:FindFirstChild("HumanoidRootPart") then vel = closest.HumanoidRootPart.Velocity elseif part.Velocity then vel = part.Velocity end
                 local pred = part.Position + (vel * config.predictionFactor)
                 Camera.CFrame = CFrame.new(Camera.CFrame.Position, pred)
             end
        end
    end)
end end)

AddToggle(TabCombat, "TriggerBot (Hold)", false, function(s) trigger=s; UpdateHUD("Trigger", s); if s then startTrigger() else if connTrigger then connTrigger:Disconnect() end; if triggerHolding then pressMouse(false) end end end)
AddToggle(TabCombat, "Prediction", true, function(s) config.usePrediction=s end)
AddToggle(TabCombat, "Wall Penetration", false, function(s) config.wallCheck = not s; UpdateHUD("Wallbang", s) end)

AddToggle(TabVisuals, "ESP", false, function(s) esp=s; UpdateHUD("ESP", s); if s then
    connEsp = RunService.Heartbeat:Connect(function()
        local targets = {}
        if config.espMode == "Players" then for _,p in pairs(Players:GetPlayers()) do if p~=LocalPlayer then table.insert(targets, p) end end
        else for _,v in pairs(workspace:GetChildren()) do if v:IsA("Model") and v:FindFirstChild("Humanoid") and v~=LocalPlayer.Character then table.insert(targets, v) end end end
        
        for _, t in pairs(targets) do
            local char = t.Character or t
            local part = getPart(char)
            if part then
                if not part:FindFirstChild("G_ESP") then
                    local bb=Instance.new("BillboardGui",part); bb.Name="G_ESP"; bb.Size=UDim2.new(0,200,0,50); bb.AlwaysOnTop=true; bb.StudsOffset=Vector3.new(0,3,0)
                    local txt=Instance.new("TextLabel",bb); txt.Size=UDim2.new(1,0,1,0); txt.BackgroundTransparency=1; txt.Font=Enum.Font.GothamBold; txt.TextStrokeTransparency=0
                end
                local txt = part.G_ESP.TextLabel
                local hp = math.floor(char.Humanoid.Health)
                local name = t.Name
                txt.Text = name .. " ["..hp.."]"
                txt.TextColor3 = (t:IsA("Player") and not isEnemy(t)) and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
            end
        end
    end)
else if connEsp then connEsp:Disconnect() end end end)

AddDropdown(TabVisuals, "ESP Mode", {"Players", "All"}, function(v) config.espMode = v end)
AddToggle(TabVisuals, "FOV Circle", true, function(s) config.showFov=s; UpdateHUD("FOV", s) end)

AddToggle(TabMisc, "Fly", false, function(s) fly=s; UpdateHUD("Fly", s); if s then
    local r=LocalPlayer.Character.HumanoidRootPart; local bg=Instance.new("BodyGyro",r); bg.maxTorque=Vector3.new(9e9,9e9,9e9); bg.CFrame=r.CFrame; local bv=Instance.new("BodyVelocity",r); bv.maxForce=Vector3.new(9e9,9e9,9e9); LocalPlayer.Character.Humanoid.PlatformStand=true
    connFly=RunService.RenderStepped:Connect(function() local c=workspace.CurrentCamera; local d=Vector3.new(); if UserInputService:IsKeyDown(Enum.KeyCode.W) then d=d+c.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.S) then d=d-c.CFrame.LookVector end; if UserInputService:IsKeyDown(Enum.KeyCode.A) then d=d-c.CFrame.RightVector end; if UserInputService:IsKeyDown(Enum.KeyCode.D) then d=d+c.CFrame.RightVector end; bv.Velocity=d*60; bg.CFrame=c.CFrame end)
else if connFly then connFly:Disconnect() end; LocalPlayer.Character.Humanoid.PlatformStand=false; for _,v in pairs(LocalPlayer.Character.HumanoidRootPart:GetChildren()) do if v:IsA("BodyGyro") or v:IsA("BodyVelocity") then v:Destroy() end end end end)

AddToggle(TabMisc, "AA Jitter", false, function(s) aa=s; UpdateHUD("AA", s); if s then connAA=RunService.Heartbeat:Connect(function() LocalPlayer.Character.Humanoid.AutoRotate=false; LocalPlayer.Character.HumanoidRootPart.CFrame=CFrame.new(LocalPlayer.Character.HumanoidRootPart.Position)*CFrame.Angles(0,math.rad(math.random(-180,180)),0) end) else if connAA then connAA:Disconnect() end; LocalPlayer.Character.Humanoid.AutoRotate=true end end)

AddDropdown(TabSettings, "Theme", {"Purple", "Blue", "Orange", "Red"}, function(v) UpdateTheme(v) end)
AddKeybind(TabSettings, "Menu Key", config.menuKey, "menuKey")
AddKeybind(TabSettings, "Trigger Key", config.triggerKey, "triggerKey")
AddKeybind(TabSettings, "Aimbot Key", config.aimKey, "aimKey")
AddKeybind(TabSettings, "ESP Key", config.espKey, "espKey")

RefreshKeybinds()
UserInputService.InputBegan:Connect(function(i, g) if not g and i.KeyCode == config.menuKey then MainFrame.Visible = not MainFrame.Visible end end)

local Circle = Instance.new("ImageLabel", ScreenGui); Circle.Image="rbxassetid://3570695787"; Circle.BackgroundTransparency=1; Circle.ImageColor3=Color3.new(1,1,1); Circle.ImageTransparency=0.5
RunService.RenderStepped:Connect(function() Circle.Visible=config.showFov and aim; Circle.Position=UDim2.new(0,Mouse.X-config.fovSize,0,Mouse.Y-config.fovSize); Circle.Size=UDim2.new(0,config.fovSize*2,0,config.fovSize*2) end)

game:GetService("StarterGui"):SetCore("SendNotification", {Title="GALAXY V16"; Text="Aimbot Fixed & Optimized"; Duration=5})
